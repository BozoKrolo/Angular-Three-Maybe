import { Component, EventEmitter, Input, Output } from '@angular/core';
import { ReplaySubject } from 'rxjs';
import { isLazyObject3dProxy } from './loaders/LazyObject3dProxy';
import { isDisposable } from './util';
import * as i0 from "@angular/core";
// eslint-disable-next-line @angular-eslint/component-class-suffix
export class ThWrapperBase {
    set objRef(ref) {
        this.applyObjRef(ref);
    }
    get objRef() {
        return this._objRef;
    }
    constructor() {
        this.autoAddToParent = true;
        this.autoDispose = true;
        // nothing to do
    }
    addToParent() {
        // nothing to do, implement it in a derived class
    }
    removeFromParent() {
        // nothing to do, implement it in a derived class
    }
    set threeEvents(eventMap) {
        this.removeEvents();
        this.eventListeners = eventMap;
        this.applyEvents();
    }
    get threeEvents() {
        return this.eventListeners;
    }
    get onUpdate() {
        if (!this.updateEmitter) {
            this.updateEmitter = new EventEmitter();
        }
        return this.updateEmitter;
    }
    /**
     * emits the last assigned object ref
     */
    get objRef$() {
        if (!this._objRef$) {
            this._objRef$ = new ReplaySubject(1);
        }
        return this._objRef$;
    }
    ngOnInit() {
        if (!this.objRef) {
            this.objRef = this.createThreeInstance(this.args);
        }
    }
    // Override this
    getType() {
        throw new Error('derive me');
    }
    createThreeInstance(args) {
        if (Array.isArray(args)) {
            return new (this.getType())(...args);
        }
        else {
            return new (this.getType())(args);
        }
    }
    ngOnChanges(changes) {
        // console.log('on changes');
        if (this.objRef && !isLazyObject3dProxy(this.objRef)) {
            // the object is already set and it is no proxy
            // emit the changes
            this.emitPropertyChanges(changes);
            // TODO: request animation frame
            return;
        }
        if (!this.objRef) {
            // no object and no proxy is set --> create an instance
            this.objRef = this.createThreeInstance(changes.args?.currentValue);
        }
        // eslint-disable-next-line guard-for-in
        for (const key in changes) {
            this[key] = changes[key].currentValue;
        }
        this.emitPropertyChanges(changes);
    }
    disposeObjRef() {
        if (isDisposable(this.objRef)) {
            this.objRef.dispose();
        }
    }
    ngOnDestroy() {
        this.removeEvents();
        this.removeFromParent();
        if (this.autoDispose) {
            this.disposeObjRef();
        }
    }
    applyObjRef(objRef) {
        if (this._objRef !== objRef) {
            this.removeFromParent();
            this._objRef = objRef;
            if (this.autoAddToParent) {
                this.addToParent();
            }
        }
        this.emitObjRefChange();
    }
    emitObjRefChange() {
        // only emit change if _objRef is no proxy,
        // and trigger emit over objRef event emitter
        if (this._objRef && !isLazyObject3dProxy(this._objRef)) {
            this._objRef.dispatchEvent?.({ type: 'loaded', object: this._objRef });
            if (this._objRef$) {
                this._objRef$.next(this._objRef);
            }
        }
    }
    emitPropertyChanges(changes) {
        if (this._objRef) {
            this._objRef.dispatchEvent?.({ type: 'changes', changes });
        }
        if (this.updateEmitter) {
            this.updateEmitter.next(changes);
        }
    }
    removeEvents() {
        if (this.eventListeners && this._objRef) {
            for (const entry of Object.entries(this.eventListeners)) {
                this._objRef.removeEventListener(entry[0], entry[1]);
            }
            this.eventListeners = undefined;
        }
    }
    applyEvents() {
        if (this.eventListeners && this._objRef) {
            for (const entry of Object.entries(this.eventListeners)) {
                this._objRef.addEventListener(entry[0], entry[1]);
            }
        }
    }
}
ThWrapperBase.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.1.1", ngImport: i0, type: ThWrapperBase, deps: [], target: i0.ɵɵFactoryTarget.Component });
ThWrapperBase.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "15.1.1", type: ThWrapperBase, selector: "th-abs-wrapper", inputs: { autoAddToParent: "autoAddToParent", autoDispose: "autoDispose", objRef: "objRef", args: "args", threeEvents: "threeEvents" }, outputs: { onUpdate: "onUpdate", objRef$: "objRef$" }, usesOnChanges: true, ngImport: i0, template: '', isInline: true });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.1.1", ngImport: i0, type: ThWrapperBase, decorators: [{
            type: Component,
            args: [{
                    selector: 'th-abs-wrapper',
                    template: ''
                }]
        }], ctorParameters: function () { return []; }, propDecorators: { autoAddToParent: [{
                type: Input
            }], autoDispose: [{
                type: Input
            }], objRef: [{
                type: Input
            }], args: [{
                type: Input
            }], threeEvents: [{
                type: Input
            }], onUpdate: [{
                type: Output
            }], objRef$: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGhXcmFwcGVyQmFzZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL25neC10aHJlZS9zcmMvbGliL1RoV3JhcHBlckJhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxZQUFZLEVBQ1osS0FBSyxFQUlMLE1BQU0sRUFHUCxNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQWMsYUFBYSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRWpELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBRWxFLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxRQUFRLENBQUM7O0FBTXRDLGtFQUFrRTtBQUNsRSxNQUFNLE9BQU8sYUFBYTtJQVV4QixJQUNJLE1BQU0sQ0FBQyxHQUFrQjtRQUMzQixJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3hCLENBQUM7SUFFRCxJQUFJLE1BQU07UUFDUixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUM7SUFDdEIsQ0FBQztJQUtEO1FBakJPLG9CQUFlLEdBQUcsSUFBSSxDQUFDO1FBR3ZCLGdCQUFXLEdBQUcsSUFBSSxDQUFDO1FBZXhCLGdCQUFnQjtJQUNsQixDQUFDO0lBRUQsV0FBVztRQUNULGlEQUFpRDtJQUNuRCxDQUFDO0lBQ0QsZ0JBQWdCO1FBQ2QsaURBQWlEO0lBQ25ELENBQUM7SUFNRCxJQUNXLFdBQVcsQ0FDcEIsUUFBOEc7UUFFOUcsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ3BCLElBQUksQ0FBQyxjQUFjLEdBQUcsUUFBUSxDQUFDO1FBQy9CLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUNyQixDQUFDO0lBRUQsSUFBVyxXQUFXO1FBQ3BCLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQztJQUM3QixDQUFDO0lBRUQsSUFDVyxRQUFRO1FBQ2pCLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFO1lBQ3ZCLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztTQUN6QztRQUNELE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQztJQUM1QixDQUFDO0lBRUQ7O09BRUc7SUFDSCxJQUNXLE9BQU87UUFDaEIsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDbEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUN0QztRQUNELE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUN2QixDQUFDO0lBRUQsUUFBUTtRQUNOLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ2hCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNuRDtJQUNILENBQUM7SUFFRCxnQkFBZ0I7SUFDVCxPQUFPO1FBQ1osTUFBTSxJQUFJLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUMvQixDQUFDO0lBRU0sbUJBQW1CLENBQUMsSUFBYztRQUN2QyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDdkIsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsR0FBSSxJQUFjLENBQUMsQ0FBQztTQUNqRDthQUFNO1lBQ0wsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDbkM7SUFDSCxDQUFDO0lBRUQsV0FBVyxDQUFDLE9BQXNCO1FBQ2hDLDZCQUE2QjtRQUM3QixJQUFJLElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsTUFBYSxDQUFDLEVBQUU7WUFDM0QsK0NBQStDO1lBRS9DLG1CQUFtQjtZQUNuQixJQUFJLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDLENBQUM7WUFFbEMsZ0NBQWdDO1lBRWhDLE9BQU87U0FDUjtRQUVELElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ2hCLHVEQUF1RDtZQUN2RCxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLFlBQVksQ0FBQyxDQUFDO1NBQ3BFO1FBRUQsd0NBQXdDO1FBQ3hDLEtBQUssTUFBTSxHQUFHLElBQUksT0FBTyxFQUFFO1lBQ3hCLElBQVksQ0FBQyxHQUFHLENBQUMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsWUFBWSxDQUFDO1NBQ2hEO1FBQ0QsSUFBSSxDQUFDLG1CQUFtQixDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3BDLENBQUM7SUFFTSxhQUFhO1FBQ2xCLElBQUksWUFBWSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUM3QixJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxDQUFDO1NBQ3ZCO0lBQ0gsQ0FBQztJQUVELFdBQVc7UUFDVCxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDcEIsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFFeEIsSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFO1lBQ3BCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztTQUN0QjtJQUNILENBQUM7SUFFUyxXQUFXLENBQUMsTUFBcUI7UUFDekMsSUFBSSxJQUFJLENBQUMsT0FBTyxLQUFLLE1BQU0sRUFBRTtZQUMzQixJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUN4QixJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztZQUN0QixJQUFJLElBQUksQ0FBQyxlQUFlLEVBQUU7Z0JBQ3hCLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQzthQUNwQjtTQUNGO1FBQ0QsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7SUFDMUIsQ0FBQztJQUVTLGdCQUFnQjtRQUN4QiwyQ0FBMkM7UUFDM0MsNkNBQTZDO1FBQzdDLElBQUksSUFBSSxDQUFDLE9BQU8sSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxPQUFjLENBQUMsRUFBRTtZQUM1RCxJQUFJLENBQUMsT0FBK0IsQ0FBQyxhQUFhLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO1lBQ2hHLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRTtnQkFDakIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQ2xDO1NBQ0Y7SUFDSCxDQUFDO0lBRVMsbUJBQW1CLENBQUMsT0FBc0I7UUFDbEQsSUFBSSxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQ2YsSUFBSSxDQUFDLE9BQXNDLENBQUMsYUFBYSxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUM7U0FDNUY7UUFDRCxJQUFJLElBQUksQ0FBQyxhQUFhLEVBQUU7WUFDdEIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDbEM7SUFDSCxDQUFDO0lBRU8sWUFBWTtRQUNsQixJQUFJLElBQUksQ0FBQyxjQUFjLElBQUksSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUN2QyxLQUFLLE1BQU0sS0FBSyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxFQUFFO2dCQUN0RCxJQUFJLENBQUMsT0FBZSxDQUFDLG1CQUFtQixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUMvRDtZQUNELElBQUksQ0FBQyxjQUFjLEdBQUcsU0FBUyxDQUFDO1NBQ2pDO0lBQ0gsQ0FBQztJQUVPLFdBQVc7UUFDakIsSUFBSSxJQUFJLENBQUMsY0FBYyxJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDdkMsS0FBSyxNQUFNLEtBQUssSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsRUFBRTtnQkFDdEQsSUFBSSxDQUFDLE9BQWUsQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDNUQ7U0FDRjtJQUNILENBQUM7OzBHQTlLVSxhQUFhOzhGQUFiLGFBQWEsMFFBSGQsRUFBRTsyRkFHRCxhQUFhO2tCQUx6QixTQUFTO21CQUFDO29CQUNULFFBQVEsRUFBRSxnQkFBZ0I7b0JBQzFCLFFBQVEsRUFBRSxFQUFFO2lCQUNiOzBFQU9RLGVBQWU7c0JBRHJCLEtBQUs7Z0JBSUMsV0FBVztzQkFEakIsS0FBSztnQkFJRixNQUFNO3NCQURULEtBQUs7Z0JBd0JDLElBQUk7c0JBRFYsS0FBSztnQkFLSyxXQUFXO3NCQURyQixLQUFLO2dCQWNLLFFBQVE7c0JBRGxCLE1BQU07Z0JBWUksT0FBTztzQkFEakIsTUFBTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENvbXBvbmVudCxcbiAgRXZlbnRFbWl0dGVyLFxuICBJbnB1dCxcbiAgT25DaGFuZ2VzLFxuICBPbkRlc3Ryb3ksXG4gIE9uSW5pdCxcbiAgT3V0cHV0LFxuICBTaW1wbGVDaGFuZ2VzLFxuICBUeXBlXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgUmVwbGF5U3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgRXZlbnREaXNwYXRjaGVyLCBPYmplY3QzRCB9IGZyb20gJ3RocmVlJztcbmltcG9ydCB7IGlzTGF6eU9iamVjdDNkUHJveHkgfSBmcm9tICcuL2xvYWRlcnMvTGF6eU9iamVjdDNkUHJveHknO1xuaW1wb3J0IHsgVGhXcmFwcGVyTGlmZUN5Y2xlIH0gZnJvbSAnLi9UaFdyYXBwZXJMaWZlQ3ljbGUnO1xuaW1wb3J0IHsgaXNEaXNwb3NhYmxlIH0gZnJvbSAnLi91dGlsJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAndGgtYWJzLXdyYXBwZXInLFxuICB0ZW1wbGF0ZTogJydcbn0pXG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQGFuZ3VsYXItZXNsaW50L2NvbXBvbmVudC1jbGFzcy1zdWZmaXhcbmV4cG9ydCBjbGFzcyBUaFdyYXBwZXJCYXNlPFQsIEFSR1MgPSB1bmtub3duPiBpbXBsZW1lbnRzIFRoV3JhcHBlckxpZmVDeWNsZSwgT25DaGFuZ2VzLCBPbkluaXQsIE9uRGVzdHJveSB7XG4gIHByb3RlY3RlZCBfb2JqUmVmPzogVDtcbiAgcHJvdGVjdGVkIF9vYmpSZWYkPzogUmVwbGF5U3ViamVjdDxUPjtcblxuICBASW5wdXQoKVxuICBwdWJsaWMgYXV0b0FkZFRvUGFyZW50ID0gdHJ1ZTtcblxuICBASW5wdXQoKVxuICBwdWJsaWMgYXV0b0Rpc3Bvc2UgPSB0cnVlO1xuXG4gIEBJbnB1dCgpXG4gIHNldCBvYmpSZWYocmVmOiBUIHwgdW5kZWZpbmVkKSB7XG4gICAgdGhpcy5hcHBseU9ialJlZihyZWYpO1xuICB9XG5cbiAgZ2V0IG9ialJlZigpIHtcbiAgICByZXR1cm4gdGhpcy5fb2JqUmVmO1xuICB9XG5cbiAgLy8gZW1pdCB0aGUgY2hhbmdlc1xuICBwcm90ZWN0ZWQgdXBkYXRlRW1pdHRlcj86IEV2ZW50RW1pdHRlcjxTaW1wbGVDaGFuZ2VzPjtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICAvLyBub3RoaW5nIHRvIGRvXG4gIH1cblxuICBhZGRUb1BhcmVudCgpOiB2b2lkIHtcbiAgICAvLyBub3RoaW5nIHRvIGRvLCBpbXBsZW1lbnQgaXQgaW4gYSBkZXJpdmVkIGNsYXNzXG4gIH1cbiAgcmVtb3ZlRnJvbVBhcmVudCgpOiB2b2lkIHtcbiAgICAvLyBub3RoaW5nIHRvIGRvLCBpbXBsZW1lbnQgaXQgaW4gYSBkZXJpdmVkIGNsYXNzXG4gIH1cblxuICBASW5wdXQoKVxuICBwdWJsaWMgYXJncz86IEFSR1M7XG5cbiAgcHJvdGVjdGVkIGV2ZW50TGlzdGVuZXJzPzogeyBba2V5OiBUSFJFRS5FdmVudFsndHlwZSddXTogVEhSRUUuRXZlbnRMaXN0ZW5lcjxUSFJFRS5FdmVudCwgVEhSRUUuRXZlbnRbJ3R5cGUnXSwgVD4gfTtcbiAgQElucHV0KClcbiAgcHVibGljIHNldCB0aHJlZUV2ZW50cyhcbiAgICBldmVudE1hcDogeyBba2V5OiBUSFJFRS5FdmVudFsndHlwZSddXTogVEhSRUUuRXZlbnRMaXN0ZW5lcjxUSFJFRS5FdmVudCwgVEhSRUUuRXZlbnRbJ3R5cGUnXSwgVD4gfSB8IHVuZGVmaW5lZFxuICApIHtcbiAgICB0aGlzLnJlbW92ZUV2ZW50cygpO1xuICAgIHRoaXMuZXZlbnRMaXN0ZW5lcnMgPSBldmVudE1hcDtcbiAgICB0aGlzLmFwcGx5RXZlbnRzKCk7XG4gIH1cblxuICBwdWJsaWMgZ2V0IHRocmVlRXZlbnRzKCkge1xuICAgIHJldHVybiB0aGlzLmV2ZW50TGlzdGVuZXJzO1xuICB9XG5cbiAgQE91dHB1dCgpXG4gIHB1YmxpYyBnZXQgb25VcGRhdGUoKTogT2JzZXJ2YWJsZTxTaW1wbGVDaGFuZ2VzPiB7XG4gICAgaWYgKCF0aGlzLnVwZGF0ZUVtaXR0ZXIpIHtcbiAgICAgIHRoaXMudXBkYXRlRW1pdHRlciA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMudXBkYXRlRW1pdHRlcjtcbiAgfVxuXG4gIC8qKlxuICAgKiBlbWl0cyB0aGUgbGFzdCBhc3NpZ25lZCBvYmplY3QgcmVmXG4gICAqL1xuICBAT3V0cHV0KClcbiAgcHVibGljIGdldCBvYmpSZWYkKCk6IE9ic2VydmFibGU8VD4ge1xuICAgIGlmICghdGhpcy5fb2JqUmVmJCkge1xuICAgICAgdGhpcy5fb2JqUmVmJCA9IG5ldyBSZXBsYXlTdWJqZWN0KDEpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fb2JqUmVmJDtcbiAgfVxuXG4gIG5nT25Jbml0KCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5vYmpSZWYpIHtcbiAgICAgIHRoaXMub2JqUmVmID0gdGhpcy5jcmVhdGVUaHJlZUluc3RhbmNlKHRoaXMuYXJncyk7XG4gICAgfVxuICB9XG5cbiAgLy8gT3ZlcnJpZGUgdGhpc1xuICBwdWJsaWMgZ2V0VHlwZSgpOiBUeXBlPGFueT4ge1xuICAgIHRocm93IG5ldyBFcnJvcignZGVyaXZlIG1lJyk7XG4gIH1cblxuICBwdWJsaWMgY3JlYXRlVGhyZWVJbnN0YW5jZShhcmdzPzogdW5rbm93bikge1xuICAgIGlmIChBcnJheS5pc0FycmF5KGFyZ3MpKSB7XG4gICAgICByZXR1cm4gbmV3ICh0aGlzLmdldFR5cGUoKSkoLi4uKGFyZ3MgYXMgYW55W10pKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG5ldyAodGhpcy5nZXRUeXBlKCkpKGFyZ3MpO1xuICAgIH1cbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcbiAgICAvLyBjb25zb2xlLmxvZygnb24gY2hhbmdlcycpO1xuICAgIGlmICh0aGlzLm9ialJlZiAmJiAhaXNMYXp5T2JqZWN0M2RQcm94eSh0aGlzLm9ialJlZiBhcyBhbnkpKSB7XG4gICAgICAvLyB0aGUgb2JqZWN0IGlzIGFscmVhZHkgc2V0IGFuZCBpdCBpcyBubyBwcm94eVxuXG4gICAgICAvLyBlbWl0IHRoZSBjaGFuZ2VzXG4gICAgICB0aGlzLmVtaXRQcm9wZXJ0eUNoYW5nZXMoY2hhbmdlcyk7XG5cbiAgICAgIC8vIFRPRE86IHJlcXVlc3QgYW5pbWF0aW9uIGZyYW1lXG5cbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMub2JqUmVmKSB7XG4gICAgICAvLyBubyBvYmplY3QgYW5kIG5vIHByb3h5IGlzIHNldCAtLT4gY3JlYXRlIGFuIGluc3RhbmNlXG4gICAgICB0aGlzLm9ialJlZiA9IHRoaXMuY3JlYXRlVGhyZWVJbnN0YW5jZShjaGFuZ2VzLmFyZ3M/LmN1cnJlbnRWYWx1ZSk7XG4gICAgfVxuXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGd1YXJkLWZvci1pblxuICAgIGZvciAoY29uc3Qga2V5IGluIGNoYW5nZXMpIHtcbiAgICAgICh0aGlzIGFzIGFueSlba2V5XSA9IGNoYW5nZXNba2V5XS5jdXJyZW50VmFsdWU7XG4gICAgfVxuICAgIHRoaXMuZW1pdFByb3BlcnR5Q2hhbmdlcyhjaGFuZ2VzKTtcbiAgfVxuXG4gIHB1YmxpYyBkaXNwb3NlT2JqUmVmKCkge1xuICAgIGlmIChpc0Rpc3Bvc2FibGUodGhpcy5vYmpSZWYpKSB7XG4gICAgICB0aGlzLm9ialJlZi5kaXNwb3NlKCk7XG4gICAgfVxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5yZW1vdmVFdmVudHMoKTtcbiAgICB0aGlzLnJlbW92ZUZyb21QYXJlbnQoKTtcblxuICAgIGlmICh0aGlzLmF1dG9EaXNwb3NlKSB7XG4gICAgICB0aGlzLmRpc3Bvc2VPYmpSZWYoKTtcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgYXBwbHlPYmpSZWYob2JqUmVmOiBUIHwgdW5kZWZpbmVkKSB7XG4gICAgaWYgKHRoaXMuX29ialJlZiAhPT0gb2JqUmVmKSB7XG4gICAgICB0aGlzLnJlbW92ZUZyb21QYXJlbnQoKTtcbiAgICAgIHRoaXMuX29ialJlZiA9IG9ialJlZjtcbiAgICAgIGlmICh0aGlzLmF1dG9BZGRUb1BhcmVudCkge1xuICAgICAgICB0aGlzLmFkZFRvUGFyZW50KCk7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuZW1pdE9ialJlZkNoYW5nZSgpO1xuICB9XG5cbiAgcHJvdGVjdGVkIGVtaXRPYmpSZWZDaGFuZ2UoKSB7XG4gICAgLy8gb25seSBlbWl0IGNoYW5nZSBpZiBfb2JqUmVmIGlzIG5vIHByb3h5LFxuICAgIC8vIGFuZCB0cmlnZ2VyIGVtaXQgb3ZlciBvYmpSZWYgZXZlbnQgZW1pdHRlclxuICAgIGlmICh0aGlzLl9vYmpSZWYgJiYgIWlzTGF6eU9iamVjdDNkUHJveHkodGhpcy5fb2JqUmVmIGFzIGFueSkpIHtcbiAgICAgICh0aGlzLl9vYmpSZWYgYXMgdW5rbm93biBhcyBPYmplY3QzRCkuZGlzcGF0Y2hFdmVudD8uKHsgdHlwZTogJ2xvYWRlZCcsIG9iamVjdDogdGhpcy5fb2JqUmVmIH0pO1xuICAgICAgaWYgKHRoaXMuX29ialJlZiQpIHtcbiAgICAgICAgdGhpcy5fb2JqUmVmJC5uZXh0KHRoaXMuX29ialJlZik7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIGVtaXRQcm9wZXJ0eUNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xuICAgIGlmICh0aGlzLl9vYmpSZWYpIHtcbiAgICAgICh0aGlzLl9vYmpSZWYgYXMgdW5rbm93biBhcyBFdmVudERpc3BhdGNoZXIpLmRpc3BhdGNoRXZlbnQ/Lih7IHR5cGU6ICdjaGFuZ2VzJywgY2hhbmdlcyB9KTtcbiAgICB9XG4gICAgaWYgKHRoaXMudXBkYXRlRW1pdHRlcikge1xuICAgICAgdGhpcy51cGRhdGVFbWl0dGVyLm5leHQoY2hhbmdlcyk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVFdmVudHMoKSB7XG4gICAgaWYgKHRoaXMuZXZlbnRMaXN0ZW5lcnMgJiYgdGhpcy5fb2JqUmVmKSB7XG4gICAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIE9iamVjdC5lbnRyaWVzKHRoaXMuZXZlbnRMaXN0ZW5lcnMpKSB7XG4gICAgICAgICh0aGlzLl9vYmpSZWYgYXMgYW55KS5yZW1vdmVFdmVudExpc3RlbmVyKGVudHJ5WzBdLCBlbnRyeVsxXSk7XG4gICAgICB9XG4gICAgICB0aGlzLmV2ZW50TGlzdGVuZXJzID0gdW5kZWZpbmVkO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXBwbHlFdmVudHMoKSB7XG4gICAgaWYgKHRoaXMuZXZlbnRMaXN0ZW5lcnMgJiYgdGhpcy5fb2JqUmVmKSB7XG4gICAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIE9iamVjdC5lbnRyaWVzKHRoaXMuZXZlbnRMaXN0ZW5lcnMpKSB7XG4gICAgICAgICh0aGlzLl9vYmpSZWYgYXMgYW55KS5hZGRFdmVudExpc3RlbmVyKGVudHJ5WzBdLCBlbnRyeVsxXSk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXX0=