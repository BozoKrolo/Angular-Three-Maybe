import { Component, inject } from '@angular/core';
import { ThAnimationLoopService } from './renderer/th-animation-loop.service';
import { ThWrapperBase } from './ThWrapperBase';
import * as i0 from "@angular/core";
import * as i1 from "./generated/ThObject3D";
import * as i2 from "./ThCanvas";
// eslint-disable-next-line @angular-eslint/component-class-suffix
export class ThControlBase extends ThWrapperBase {
    constructor(_camera, canvas) {
        super();
        this._camera = _camera;
        this.canvas = canvas;
        this.renderLoop = inject(ThAnimationLoopService);
    }
    createThreeInstance(args) {
        if (!args) {
            args = [this._camera.objRef, this.canvas?.rendererCanvas?.nativeElement];
        }
        const instance = super.createThreeInstance(args);
        this.patchDispatchEvent(instance);
        this.subscribeControlUpdater(instance);
        return instance;
    }
    patchDispatchEvent(dispatcher) {
        if (dispatcher.dispatchEvent) {
            const origMethod = (this.origDispatchEventMethod = dispatcher.dispatchEvent);
            dispatcher.dispatchEvent = (event) => {
                origMethod.call(dispatcher, event);
                // request an animation frame after an event was emitted;
                this.renderLoop.requestAnimationFrame();
            };
        }
    }
    ngOnDestroy() {
        super.ngOnDestroy();
        this.unpatchDispatchEvent();
        this.unsubscribeControlUpdater();
    }
    unpatchDispatchEvent() {
        if (this.origDispatchEventMethod && this._objRef) {
            this._objRef.dispatchEvent = this.origDispatchEventMethod;
        }
    }
    subscribeControlUpdater(control) {
        if (control.update !== undefined) {
            this.beforeRenderSubscription = this.renderLoop.beforeRender$.subscribe((state) => {
                control.update(state.delta);
            });
        }
    }
    unsubscribeControlUpdater() {
        if (this.beforeRenderSubscription) {
            this.beforeRenderSubscription.unsubscribe();
        }
    }
}
ThControlBase.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.1.1", ngImport: i0, type: ThControlBase, deps: [{ token: i1.ThObject3D }, { token: i2.ThCanvas }], target: i0.ɵɵFactoryTarget.Component });
ThControlBase.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "15.1.1", type: ThControlBase, selector: "th-abs-control", usesInheritance: true, ngImport: i0, template: '', isInline: true });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.1.1", ngImport: i0, type: ThControlBase, decorators: [{
            type: Component,
            args: [{
                    selector: 'th-abs-control',
                    template: ''
                }]
        }], ctorParameters: function () { return [{ type: i1.ThObject3D }, { type: i2.ThCanvas }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGhDb250cm9sQmFzZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL25neC10aHJlZS9zcmMvbGliL1RoQ29udHJvbEJhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQWEsTUFBTSxlQUFlLENBQUM7QUFJN0QsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFFOUUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGlCQUFpQixDQUFDOzs7O0FBS2hELGtFQUFrRTtBQUNsRSxNQUFNLE9BQU8sYUFBdUIsU0FBUSxhQUFzQjtJQUtoRSxZQUFzQixPQUF3QixFQUFZLE1BQWlCO1FBQ3pFLEtBQUssRUFBRSxDQUFDO1FBRFksWUFBTyxHQUFQLE9BQU8sQ0FBaUI7UUFBWSxXQUFNLEdBQU4sTUFBTSxDQUFXO1FBRmpFLGVBQVUsR0FBRyxNQUFNLENBQUMsc0JBQXNCLENBQUMsQ0FBQztJQUl0RCxDQUFDO0lBRU0sbUJBQW1CLENBQUMsSUFBb0I7UUFDN0MsSUFBSSxDQUFDLElBQUksRUFBRTtZQUNULElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNLEVBQUUsY0FBYyxFQUFFLGFBQWEsQ0FBQyxDQUFDO1NBQzFFO1FBQ0QsTUFBTSxRQUFRLEdBQTZCLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMzRSxJQUFJLENBQUMsa0JBQWtCLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDbEMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLFFBQWUsQ0FBQyxDQUFDO1FBQzlDLE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7SUFFUyxrQkFBa0IsQ0FBQyxVQUFvQztRQUMvRCxJQUFJLFVBQVUsQ0FBQyxhQUFhLEVBQUU7WUFDNUIsTUFBTSxVQUFVLEdBQUcsQ0FBQyxJQUFJLENBQUMsdUJBQXVCLEdBQUcsVUFBVSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1lBQzdFLFVBQVUsQ0FBQyxhQUFhLEdBQUcsQ0FBQyxLQUFVLEVBQUUsRUFBRTtnQkFDeEMsVUFBVSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsS0FBSyxDQUFDLENBQUM7Z0JBQ25DLHlEQUF5RDtnQkFDekQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1lBQzFDLENBQUMsQ0FBQztTQUNIO0lBQ0gsQ0FBQztJQUVNLFdBQVc7UUFDaEIsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ3BCLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1FBQzVCLElBQUksQ0FBQyx5QkFBeUIsRUFBRSxDQUFDO0lBQ25DLENBQUM7SUFFUyxvQkFBb0I7UUFDNUIsSUFBSSxJQUFJLENBQUMsdUJBQXVCLElBQUksSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUMvQyxJQUFJLENBQUMsT0FBc0MsQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLHVCQUF1QixDQUFDO1NBQzNGO0lBQ0gsQ0FBQztJQUVTLHVCQUF1QixDQUFDLE9BQTRDO1FBQzVFLElBQUksT0FBTyxDQUFDLE1BQU0sS0FBSyxTQUFTLEVBQUU7WUFDaEMsSUFBSSxDQUFDLHdCQUF3QixHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFO2dCQUNoRixPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUM5QixDQUFDLENBQUMsQ0FBQztTQUNKO0lBQ0gsQ0FBQztJQUVTLHlCQUF5QjtRQUNqQyxJQUFJLElBQUksQ0FBQyx3QkFBd0IsRUFBRTtZQUNqQyxJQUFJLENBQUMsd0JBQXdCLENBQUMsV0FBVyxFQUFFLENBQUM7U0FDN0M7SUFDSCxDQUFDOzswR0F0RFUsYUFBYTs4RkFBYixhQUFhLDZFQUhkLEVBQUU7MkZBR0QsYUFBYTtrQkFMekIsU0FBUzttQkFBQztvQkFDVCxRQUFRLEVBQUUsZ0JBQWdCO29CQUMxQixRQUFRLEVBQUUsRUFBRTtpQkFDYiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgaW5qZWN0LCBPbkRlc3Ryb3kgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgRXZlbnREaXNwYXRjaGVyIH0gZnJvbSAndGhyZWUnO1xuaW1wb3J0IHsgVGhPYmplY3QzRCB9IGZyb20gJy4vZ2VuZXJhdGVkL1RoT2JqZWN0M0QnO1xuaW1wb3J0IHsgVGhBbmltYXRpb25Mb29wU2VydmljZSB9IGZyb20gJy4vcmVuZGVyZXIvdGgtYW5pbWF0aW9uLWxvb3Auc2VydmljZSc7XG5pbXBvcnQgeyBUaENhbnZhcyB9IGZyb20gJy4vVGhDYW52YXMnO1xuaW1wb3J0IHsgVGhXcmFwcGVyQmFzZSB9IGZyb20gJy4vVGhXcmFwcGVyQmFzZSc7XG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICd0aC1hYnMtY29udHJvbCcsXG4gIHRlbXBsYXRlOiAnJ1xufSlcbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAYW5ndWxhci1lc2xpbnQvY29tcG9uZW50LWNsYXNzLXN1ZmZpeFxuZXhwb3J0IGNsYXNzIFRoQ29udHJvbEJhc2U8VCwgQVJHUz4gZXh0ZW5kcyBUaFdyYXBwZXJCYXNlPFQsIEFSR1M+IGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgcHJvdGVjdGVkIG9yaWdEaXNwYXRjaEV2ZW50TWV0aG9kPzogKGV2ZW50OiBhbnkpID0+IHZvaWQ7XG4gIHByb3RlY3RlZCBiZWZvcmVSZW5kZXJTdWJzY3JpcHRpb24/OiBTdWJzY3JpcHRpb247XG4gIHByb3RlY3RlZCByZW5kZXJMb29wID0gaW5qZWN0KFRoQW5pbWF0aW9uTG9vcFNlcnZpY2UpO1xuXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBfY2FtZXJhOiBUaE9iamVjdDNEPGFueT4sIHByb3RlY3RlZCBjYW52YXM/OiBUaENhbnZhcykge1xuICAgIHN1cGVyKCk7XG4gIH1cblxuICBwdWJsaWMgY3JlYXRlVGhyZWVJbnN0YW5jZShhcmdzPzogSXRlcmFibGU8YW55Pikge1xuICAgIGlmICghYXJncykge1xuICAgICAgYXJncyA9IFt0aGlzLl9jYW1lcmEub2JqUmVmLCB0aGlzLmNhbnZhcz8ucmVuZGVyZXJDYW52YXM/Lm5hdGl2ZUVsZW1lbnRdO1xuICAgIH1cbiAgICBjb25zdCBpbnN0YW5jZTogUGFydGlhbDxFdmVudERpc3BhdGNoZXI+ID0gc3VwZXIuY3JlYXRlVGhyZWVJbnN0YW5jZShhcmdzKTtcbiAgICB0aGlzLnBhdGNoRGlzcGF0Y2hFdmVudChpbnN0YW5jZSk7XG4gICAgdGhpcy5zdWJzY3JpYmVDb250cm9sVXBkYXRlcihpbnN0YW5jZSBhcyBhbnkpO1xuICAgIHJldHVybiBpbnN0YW5jZTtcbiAgfVxuXG4gIHByb3RlY3RlZCBwYXRjaERpc3BhdGNoRXZlbnQoZGlzcGF0Y2hlcjogUGFydGlhbDxFdmVudERpc3BhdGNoZXI+KSB7XG4gICAgaWYgKGRpc3BhdGNoZXIuZGlzcGF0Y2hFdmVudCkge1xuICAgICAgY29uc3Qgb3JpZ01ldGhvZCA9ICh0aGlzLm9yaWdEaXNwYXRjaEV2ZW50TWV0aG9kID0gZGlzcGF0Y2hlci5kaXNwYXRjaEV2ZW50KTtcbiAgICAgIGRpc3BhdGNoZXIuZGlzcGF0Y2hFdmVudCA9IChldmVudDogYW55KSA9PiB7XG4gICAgICAgIG9yaWdNZXRob2QuY2FsbChkaXNwYXRjaGVyLCBldmVudCk7XG4gICAgICAgIC8vIHJlcXVlc3QgYW4gYW5pbWF0aW9uIGZyYW1lIGFmdGVyIGFuIGV2ZW50IHdhcyBlbWl0dGVkO1xuICAgICAgICB0aGlzLnJlbmRlckxvb3AucmVxdWVzdEFuaW1hdGlvbkZyYW1lKCk7XG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICBzdXBlci5uZ09uRGVzdHJveSgpO1xuICAgIHRoaXMudW5wYXRjaERpc3BhdGNoRXZlbnQoKTtcbiAgICB0aGlzLnVuc3Vic2NyaWJlQ29udHJvbFVwZGF0ZXIoKTtcbiAgfVxuXG4gIHByb3RlY3RlZCB1bnBhdGNoRGlzcGF0Y2hFdmVudCgpIHtcbiAgICBpZiAodGhpcy5vcmlnRGlzcGF0Y2hFdmVudE1ldGhvZCAmJiB0aGlzLl9vYmpSZWYpIHtcbiAgICAgICh0aGlzLl9vYmpSZWYgYXMgdW5rbm93biBhcyBFdmVudERpc3BhdGNoZXIpLmRpc3BhdGNoRXZlbnQgPSB0aGlzLm9yaWdEaXNwYXRjaEV2ZW50TWV0aG9kO1xuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBzdWJzY3JpYmVDb250cm9sVXBkYXRlcihjb250cm9sOiB7IHVwZGF0ZTogKGRlbHRhOiBudW1iZXIpID0+IHZvaWQgfSkge1xuICAgIGlmIChjb250cm9sLnVwZGF0ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aGlzLmJlZm9yZVJlbmRlclN1YnNjcmlwdGlvbiA9IHRoaXMucmVuZGVyTG9vcC5iZWZvcmVSZW5kZXIkLnN1YnNjcmliZSgoc3RhdGUpID0+IHtcbiAgICAgICAgY29udHJvbC51cGRhdGUoc3RhdGUuZGVsdGEpO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIHVuc3Vic2NyaWJlQ29udHJvbFVwZGF0ZXIoKSB7XG4gICAgaWYgKHRoaXMuYmVmb3JlUmVuZGVyU3Vic2NyaXB0aW9uKSB7XG4gICAgICB0aGlzLmJlZm9yZVJlbmRlclN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIH1cbiAgfVxufVxuIl19