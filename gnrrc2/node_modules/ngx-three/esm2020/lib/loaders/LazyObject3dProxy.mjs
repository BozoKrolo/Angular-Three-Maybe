import { Object3D } from 'three';
import { applyValue, isSettable } from '../util';
class Object3DProxyHandler {
    constructor(target) {
        this.memberMap = new Map();
        this.children = [];
        this.eventListener = {};
        this.loaded = false;
        this.add = (...object) => {
            if (this.objRef) {
                this.objRef.add(...object);
            }
            this.children.push(...object);
            return this;
        };
        this.remove = (...object) => {
            if (this.objRef) {
                this.objRef.remove(...object);
            }
            for (const obj of object) {
                const index = this.children.indexOf(obj);
                if (index >= 0) {
                    this.children = this.children.splice(index, 1);
                }
            }
            return this;
        };
        this.applyToObject3D = (objRef) => {
            this.memberMap.forEach((value, key) => {
                const member = objRef[key];
                if (isSettable(member)) {
                    applyValue(member, value);
                }
                else {
                    objRef[key] = value;
                }
            });
            this.children.forEach((child) => objRef.add(child));
            if (this.objRef?.parent) {
                const parent = this.objRef?.parent;
                parent.remove(this.objRef);
                parent.add(objRef);
            }
        };
        /**
         * Adds a listener to an event type.
         *
         * @param type The type of event to listen to.
         * @param listener The function that gets called when the event is fired.
         */
        this.addEventListener = (type, listener) => {
            let arr = this.eventListener[type];
            if (!arr) {
                arr = [];
                this.eventListener[type] = arr;
            }
            arr.push(listener);
            if (this.objRef) {
                this.objRef.addEventListener(type, listener);
            }
        };
        /**
         * Removes a listener from an event type.
         *
         * @param type The type of the listener that gets removed.
         * @param listener The listener function that gets removed.
         */
        this.removeEventListener = (type, listener) => {
            const arr = this.eventListener[type];
            if (!arr) {
                return;
            }
            const index = arr.indexOf(listener);
            if (index >= 0) {
                arr.splice(index, 1);
            }
        };
        this.objRef = target;
    }
    get(_target, p, receiver) {
        switch (p) {
            case '__isProxy':
                return true;
            case 'applyToObject3D':
                return this.applyToObject3D;
            case 'objRef':
                if (this.loaded) {
                    return this.objRef;
                }
                else {
                    return undefined;
                }
            case 'add':
                return this.add;
            case 'remove':
                return this.remove;
            case 'children':
                return this.objRef ? this.objRef.children : this.children;
            default: {
                const objKey = p;
                const value = this.objRef[objKey];
                if (value !== undefined) {
                    // this is necessary for complex members
                    // (returned by reference, they might be altered, we have to reapply them to the real object )
                    this.memberMap.set(objKey, value);
                }
                return value;
            }
        }
    }
    set(_target, p, value, _receiver) {
        if (p === 'objRef') {
            if (value) {
                this.applyToObject3D(value);
            }
            this.loaded = true;
            this.objRef = value;
        }
        else {
            // store to the member map
            this.memberMap.set(p, value);
            if (this.objRef) {
                // and apply to the real object if present
                this.objRef[p] = value;
            }
        }
        return true;
    }
}
export function createLazyObject3DProxy(target = new Object3D()) {
    const handler = new Object3DProxyHandler(target);
    return new Proxy(handler, handler);
}
export function isLazyObject3dProxy(object) {
    return (
    // eslint-disable-next-line no-underscore-dangle
    object.__isProxy === true && object.objRef === undefined);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTGF6eU9iamVjdDNkUHJveHkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtdGhyZWUvc3JjL2xpYi9sb2FkZXJzL0xhenlPYmplY3QzZFByb3h5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQVMsTUFBTSxPQUFPLENBQUM7QUFDeEMsT0FBTyxFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFakQsTUFBTSxvQkFBb0I7SUFDeEIsWUFBWSxNQUFnQjtRQUtsQixjQUFTLEdBQUcsSUFBSSxHQUFHLEVBQXVCLENBQUM7UUFDM0MsYUFBUSxHQUFlLEVBQUUsQ0FBQztRQUMxQixrQkFBYSxHQUFrRCxFQUFFLENBQUM7UUFDbEUsV0FBTSxHQUFHLEtBQUssQ0FBQztRQW1EekIsUUFBRyxHQUFHLENBQUMsR0FBRyxNQUFrQixFQUFRLEVBQUU7WUFDcEMsSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFO2dCQUNmLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUM7YUFDNUI7WUFFRCxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLE1BQU0sQ0FBQyxDQUFDO1lBRTlCLE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQyxDQUFDO1FBRUYsV0FBTSxHQUFHLENBQUMsR0FBRyxNQUFrQixFQUFRLEVBQUU7WUFDdkMsSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFO2dCQUNmLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUM7YUFDL0I7WUFFRCxLQUFLLE1BQU0sR0FBRyxJQUFJLE1BQU0sRUFBRTtnQkFDeEIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ3pDLElBQUksS0FBSyxJQUFJLENBQUMs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QW1GRjtBQVNELE1BQU0sVUFBVSx1QkFBdUIsQ0FBQyxNQUFNLEdBQUcsSUFBSSxRQUFRLEVBQUU7SUFDN0QsTUFBTSxPQUFPLEdBQUcsSUFBSSxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNqRCxPQUFPLElBQUksS0FBSyxDQUFvQixPQUF1QyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0FBQ3hGLENBQUM7QUFFRCxNQUFNLFVBQVUsbUJBQW1CLENBQUMsTUFBb0M7SUFDdEUsT0FBTztJQUNMLGdEQUFnRDtJQUMvQyxNQUE0QixDQUFDLFNBQVMsS0FBSyxJQUFJLElBQUssTUFBNEIsQ0FBQyxNQUFNLEtBQUssU0FBUyxDQUN2RyxDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9iamVjdDNELCBFdmVudCB9IGZyb20gJ3RocmVlJztcbmltcG9ydCB7IGFwcGx5VmFsdWUsIGlzU2V0dGFibGUgfSBmcm9tICcuLi91dGlsJztcblxuY2xhc3MgT2JqZWN0M0RQcm94eUhhbmRsZXIgaW1wbGVtZW50cyBQcm94eUhhbmRsZXI8T2JqZWN0M0Q+IHtcbiAgY29uc3RydWN0b3IodGFyZ2V0OiBPYmplY3QzRCkge1xuICAgIHRoaXMub2JqUmVmID0gdGFyZ2V0O1xuICB9XG5cbiAgcHJvdGVjdGVkIG9ialJlZjogT2JqZWN0M0Q7XG4gIHByb3RlY3RlZCBtZW1iZXJNYXAgPSBuZXcgTWFwPGtleW9mIE9iamVjdDNELCBhbnk+KCk7XG4gIHByb3RlY3RlZCBjaGlsZHJlbjogT2JqZWN0M0RbXSA9IFtdO1xuICBwcm90ZWN0ZWQgZXZlbnRMaXN0ZW5lcjogeyBba2V5OiBzdHJpbmddOiAoKGV2ZW50OiBFdmVudCkgPT4gdm9pZClbXSB9ID0ge307XG4gIHByb3RlY3RlZCBsb2FkZWQgPSBmYWxzZTtcblxuICBnZXQoX3RhcmdldDogdW5rbm93biwgcDoga2V5b2YgTGF6eU9iamVjdDNEUHJveHksIHJlY2VpdmVyOiBhbnkpOiBhbnkge1xuICAgIHN3aXRjaCAocCkge1xuICAgICAgY2FzZSAnX19pc1Byb3h5JzpcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICBjYXNlICdhcHBseVRvT2JqZWN0M0QnOlxuICAgICAgICByZXR1cm4gdGhpcy5hcHBseVRvT2JqZWN0M0Q7XG4gICAgICBjYXNlICdvYmpSZWYnOlxuICAgICAgICBpZiAodGhpcy5sb2FkZWQpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5vYmpSZWY7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgICAgY2FzZSAnYWRkJzpcbiAgICAgICAgcmV0dXJuIHRoaXMuYWRkO1xuICAgICAgY2FzZSAncmVtb3ZlJzpcbiAgICAgICAgcmV0dXJuIHRoaXMucmVtb3ZlO1xuICAgICAgY2FzZSAnY2hpbGRyZW4nOlxuICAgICAgICByZXR1cm4gdGhpcy5vYmpSZWYgPyB0aGlzLm9ialJlZi5jaGlsZHJlbiA6IHRoaXMuY2hpbGRyZW47XG4gICAgICBkZWZhdWx0OiB7XG4gICAgICAgIGNvbnN0IG9iaktleSA9IHAgYXMga2V5b2YgT2JqZWN0M0Q7XG4gICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5vYmpSZWZbb2JqS2V5XTtcbiAgICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAvLyB0aGlzIGlzIG5lY2Vzc2FyeSBmb3IgY29tcGxleCBtZW1iZXJzXG4gICAgICAgICAgLy8gKHJldHVybmVkIGJ5IHJlZmVyZW5jZSwgdGhleSBtaWdodCBiZSBhbHRlcmVkLCB3ZSBoYXZlIHRvIHJlYXBwbHkgdGhlbSB0byB0aGUgcmVhbCBvYmplY3QgKVxuICAgICAgICAgIHRoaXMubWVtYmVyTWFwLnNldChvYmpLZXksIHZhbHVlKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgc2V0KF90YXJnZXQ6IHVua25vd24sIHA6IGtleW9mIExhenlPYmplY3QzRFByb3h5LCB2YWx1ZTogYW55LCBfcmVjZWl2ZXI6IGFueSk6IGJvb2xlYW4ge1xuICAgIGlmIChwID09PSAnb2JqUmVmJykge1xuICAgICAgaWYgKHZhbHVlKSB7XG4gICAgICAgIHRoaXMuYXBwbHlUb09iamVjdDNEKHZhbHVlKTtcbiAgICAgIH1cbiAgICAgIHRoaXMubG9hZGVkID0gdHJ1ZTtcbiAgICAgIHRoaXMub2JqUmVmID0gdmFsdWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIHN0b3JlIHRvIHRoZSBtZW1iZXIgbWFwXG4gICAgICB0aGlzLm1lbWJlck1hcC5zZXQocCBhcyBrZXlvZiBPYmplY3QzRCwgdmFsdWUpO1xuICAgICAgaWYgKHRoaXMub2JqUmVmKSB7XG4gICAgICAgIC8vIGFuZCBhcHBseSB0byB0aGUgcmVhbCBvYmplY3QgaWYgcHJlc2VudFxuICAgICAgICAodGhpcy5vYmpSZWYgYXMgYW55KVtwXSA9IHZhbHVlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIGFkZCA9ICguLi5vYmplY3Q6IE9iamVjdDNEW10pOiB0aGlzID0+IHtcbiAgICBpZiAodGhpcy5vYmpSZWYpIHtcbiAgICAgIHRoaXMub2JqUmVmLmFkZCguLi5vYmplY3QpO1xuICAgIH1cblxuICAgIHRoaXMuY2hpbGRyZW4ucHVzaCguLi5vYmplY3QpO1xuXG4gICAgcmV0dXJuIHRoaXM7XG4gIH07XG5cbiAgcmVtb3ZlID0gKC4uLm9iamVjdDogT2JqZWN0M0RbXSk6IHRoaXMgPT4ge1xuICAgIGlmICh0aGlzLm9ialJlZikge1xuICAgICAgdGhpcy5vYmpSZWYucmVtb3ZlKC4uLm9iamVjdCk7XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBvYmogb2Ygb2JqZWN0KSB7XG4gICAgICBjb25zdCBpbmRleCA9IHRoaXMuY2hpbGRyZW4uaW5kZXhPZihvYmopO1xuICAgICAgaWYgKGluZGV4ID49IDApIHtcbiAgICAgICAgdGhpcy5jaGlsZHJlbiA9IHRoaXMuY2hpbGRyZW4uc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcztcbiAgfTtcblxuICBhcHBseVRvT2JqZWN0M0QgPSAob2JqUmVmOiBPYmplY3QzRCkgPT4ge1xuICAgIHRoaXMubWVtYmVyTWFwLmZvckVhY2goKHZhbHVlLCBrZXkpID0+IHtcbiAgICAgIGNvbnN0IG1lbWJlciA9IChvYmpSZWYgYXMgYW55KVtrZXldO1xuICAgICAgaWYgKGlzU2V0dGFibGUobWVtYmVyKSkge1xuICAgICAgICBhcHBseVZhbHVlKG1lbWJlciwgdmFsdWUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgKG9ialJlZiBhcyBhbnkpW2tleV0gPSB2YWx1ZTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHRoaXMuY2hpbGRyZW4uZm9yRWFjaCgoY2hpbGQpID0+IG9ialJlZi5hZGQoY2hpbGQpKTtcblxuICAgIGlmICh0aGlzLm9ialJlZj8ucGFyZW50KSB7XG4gICAgICBjb25zdCBwYXJlbnQgPSB0aGlzLm9ialJlZj8ucGFyZW50O1xuICAgICAgcGFyZW50LnJlbW92ZSh0aGlzLm9ialJlZik7XG4gICAgICBwYXJlbnQuYWRkKG9ialJlZik7XG4gICAgfVxuICB9O1xuXG4gIC8qKlxuICAgKiBBZGRzIGEgbGlzdGVuZXIgdG8gYW4gZXZlbnQgdHlwZS5cbiAgICpcbiAgICogQHBhcmFtIHR5cGUgVGhlIHR5cGUgb2YgZXZlbnQgdG8gbGlzdGVuIHRvLlxuICAgKiBAcGFyYW0gbGlzdGVuZXIgVGhlIGZ1bmN0aW9uIHRoYXQgZ2V0cyBjYWxsZWQgd2hlbiB0aGUgZXZlbnQgaXMgZmlyZWQuXG4gICAqL1xuICBhZGRFdmVudExpc3RlbmVyID0gKHR5cGU6IHN0cmluZywgbGlzdGVuZXI6IChldmVudDogRXZlbnQpID0+IHZvaWQpOiB2b2lkID0+IHtcbiAgICBsZXQgYXJyID0gdGhpcy5ldmVudExpc3RlbmVyW3R5cGVdO1xuICAgIGlmICghYXJyKSB7XG4gICAgICBhcnIgPSBbXTtcbiAgICAgIHRoaXMuZXZlbnRMaXN0ZW5lclt0eXBlXSA9IGFycjtcbiAgICB9XG5cbiAgICBhcnIucHVzaChsaXN0ZW5lcik7XG5cbiAgICBpZiAodGhpcy5vYmpSZWYpIHtcbiAgICAgIHRoaXMub2JqUmVmLmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgbGlzdGVuZXIpO1xuICAgIH1cbiAgfTtcblxuICAvKipcbiAgICogUmVtb3ZlcyBhIGxpc3RlbmVyIGZyb20gYW4gZXZlbnQgdHlwZS5cbiAgICpcbiAgICogQHBhcmFtIHR5cGUgVGhlIHR5cGUgb2YgdGhlIGxpc3RlbmVyIHRoYXQgZ2V0cyByZW1vdmVkLlxuICAgKiBAcGFyYW0gbGlzdGVuZXIgVGhlIGxpc3RlbmVyIGZ1bmN0aW9uIHRoYXQgZ2V0cyByZW1vdmVkLlxuICAgKi9cbiAgcmVtb3ZlRXZlbnRMaXN0ZW5lciA9ICh0eXBlOiBzdHJpbmcsIGxpc3RlbmVyOiAoZXZlbnQ6IEV2ZW50KSA9PiB2b2lkKTogdm9pZCA9PiB7XG4gICAgY29uc3QgYXJyID0gdGhpcy5ldmVudExpc3RlbmVyW3R5cGVdO1xuICAgIGlmICghYXJyKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgaW5kZXggPSBhcnIuaW5kZXhPZihsaXN0ZW5lcik7XG4gICAgaWYgKGluZGV4ID49IDApIHtcbiAgICAgIGFyci5zcGxpY2UoaW5kZXgsIDEpO1xuICAgIH1cbiAgfTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBMYXp5T2JqZWN0M0RQcm94eSBleHRlbmRzIE9iamVjdDNEIHtcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uYW1pbmctY29udmVudGlvblxuICByZWFkb25seSBfX2lzUHJveHk/OiBib29sZWFuO1xuICBvYmpSZWY/OiBPYmplY3QzRDtcbiAgYXBwbHlUb09iamVjdDNEKHJlYWw6IE9iamVjdDNEKTogdm9pZDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUxhenlPYmplY3QzRFByb3h5KHRhcmdldCA9IG5ldyBPYmplY3QzRCgpKTogTGF6eU9iamVjdDNEUHJveHkge1xuICBjb25zdCBoYW5kbGVyID0gbmV3IE9iamVjdDNEUHJveHlIYW5kbGVyKHRhcmdldCk7XG4gIHJldHVybiBuZXcgUHJveHk8TGF6eU9iamVjdDNEUHJveHk+KGhhbmRsZXIgYXMgdW5rbm93biBhcyBMYXp5T2JqZWN0M0RQcm94eSwgaGFuZGxlcik7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0xhenlPYmplY3QzZFByb3h5KG9iamVjdDogT2JqZWN0M0QgfCBMYXp5T2JqZWN0M0RQcm94eSk6IG9iamVjdCBpcyBMYXp5T2JqZWN0M0RQcm94eSB7XG4gIHJldHVybiAoXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVuZGVyc2NvcmUtZGFuZ2xlXG4gICAgKG9iamVjdCBhcyBMYXp5T2JqZWN0M0RQcm94eSkuX19pc1Byb3h5ID09PSB0cnVlICYmIChvYmplY3QgYXMgTGF6eU9iamVjdDNEUHJveHkpLm9ialJlZiA9PT0gdW5kZWZpbmVkXG4gICk7XG59XG4iXX0=