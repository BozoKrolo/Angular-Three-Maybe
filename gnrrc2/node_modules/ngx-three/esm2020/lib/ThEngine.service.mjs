import { EventEmitter, Injectable } from '@angular/core';
import * as THREE from 'three';
import { Clock, Vector4 } from 'three';
import { isObserved } from './util';
import { Subject, takeUntil } from 'rxjs';
import * as i0 from "@angular/core";
const RENDERER_DEFAULTS = {
    alpha: true,
    antialias: true,
    preserveDrawingBuffer: true
};
export class ThEngineService {
    get canvas() {
        return this.rendererParameters?.domElement;
    }
    constructor(ngZone) {
        this.ngZone = ngZone;
        this.clock = new Clock();
        this.destroyed$ = new Subject();
        this.resizeEmitter = new EventEmitter();
        this.beforeRenderEmitter = new EventEmitter();
        this.views = [];
        this.beforeRender$ = this.beforeRenderEmitter.pipe(takeUntil(this.destroyed$));
        this.resize$ = this.resizeEmitter.pipe(takeUntil(this.destroyed$));
    }
    get renderer() {
        return this._renderer;
    }
    ngOnDestroy() {
        if (this.resizeObserver && this.canvas) {
            this.resizeObserver.unobserve(this.canvas);
        }
    }
    initResizeObserver() {
        // We have to run this outside angular zones,
        // because it could trigger heavy changeDetection cycles.
        this.ngZone.runOutsideAngular(() => {
            if (!this.canvas) {
                throw new Error('missing canvas element');
            }
            this.resize();
            if (!this.resizeObserver) {
                // @ts-ignore
                this.resizeObserver = new ResizeObserver(() => {
                    this.resize();
                });
            }
            this.resizeObserver.observe(this.canvas);
        });
    }
    initRenderer() {
        if (this._renderer) {
            return;
        }
        this._renderer = new THREE.WebGLRenderer({
            canvas: this.rendererParameters?.domElement,
            ...RENDERER_DEFAULTS
        });
        Object.assign(this._renderer, { ...RENDERER_DEFAULTS, ...this.rendererParameters });
        this.resize();
    }
    setRenderer(options) {
        this.rendererParameters = options;
        this.initRenderer();
        this.initResizeObserver();
    }
    addView(view) {
        this.views.push(view);
        const canvasDimensions = this.calcRendererSize();
        if (canvasDimensions) {
            this.adjustViewDimensions(view, canvasDimensions.width, canvasDimensions.height);
        }
    }
    render() {
        this.beforeRenderEmitter.emit({ engine: this, delta: this.clock.getDelta() });
        for (const view of this.views) {
            this.renderView(view);
        }
    }
    renderView(view) {
        if (!this._renderer) {
            return;
        }
        const camera = view.camera;
        const scene = view.scene;
        if (!camera || !scene || !camera.objRef || !scene.objRef) {
            return;
        }
        const renderer = this._renderer;
        if (isObserved(view.onRender)) {
            this.ngZone.run(() => view.onRender.emit({
                renderer,
                scene,
                camera
            }));
        }
        this.applyRendererParametersFromView(view);
        if (view.effectComposer) {
            view.effectComposer.render();
        }
        else {
            this._renderer.render(scene.objRef, camera.objRef);
        }
    }
    applyRendererParametersFromView(view) {
        if (!this._renderer) {
            return;
        }
        if (view.viewPort) {
            if (view.viewPort instanceof Vector4) {
                this._renderer.setViewport(view.viewPort);
            }
            else {
                this._renderer.setViewport(view.viewPort.x, view.viewPort.y, view.viewPort.width, view.viewPort.height);
            }
        }
        if (view.scissor) {
            if (view.scissor instanceof Vector4) {
                this._renderer.setScissor(view.scissor);
            }
            else {
                this._renderer.setScissor(view.scissor.x, view.scissor.y, view.scissor.width, view.scissor.height);
            }
        }
        if (view.scissorTest !== undefined) {
            this._renderer.setScissorTest(view.scissorTest);
        }
        if (view.clearColor) {
            this._renderer.setClearColor(view.clearColor);
        }
        if (view.clearAlpha !== undefined) {
            this._renderer.setClearAlpha(view.clearAlpha);
        }
        if (view.shadow !== undefined) {
            this._renderer.shadowMap.enabled = true;
        }
    }
    resize() {
        if (!this._renderer || !this.canvas) {
            return false;
        }
        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
        const { width, height } = this.calcRendererSize();
        this._renderer.setSize(width, height, false);
        for (const view of this.views) {
            this.adjustViewDimensions(view, width, height);
        }
        this.resizeEmitter.emit({ width, height });
        return true;
    }
    calcRendererSize() {
        if (!this._renderer || !this.canvas) {
            return;
        }
        const pixelRatio = window.devicePixelRatio;
        return {
            width: (this.canvas.clientWidth ?? 0) * pixelRatio,
            height: (this.canvas.clientHeight ?? 0) * pixelRatio
        };
    }
    adjustViewDimensions(view, width, height) {
        if (!view.viewPort) {
            if (view.camera && view.camera.objRef.aspect) {
                view.camera.objRef.aspect = width / height;
                view.camera.objRef.updateProjectionMatrix();
            }
            view.effectComposer?.setSize(width, height);
        }
    }
}
ThEngineService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.1.1", ngImport: i0, type: ThEngineService, deps: [{ token: i0.NgZone }], target: i0.ɵɵFactoryTarget.Injectable });
ThEngineService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.1.1", ngImport: i0, type: ThEngineService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.1.1", ngImport: i0, type: ThEngineService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i0.NgZone }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGhFbmdpbmUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL25neC10aHJlZS9zcmMvbGliL1RoRW5naW5lLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFlBQVksRUFBc0IsVUFBVSxFQUFxQixNQUFNLGVBQWUsQ0FBQztBQUNoRyxPQUFPLEtBQUssS0FBSyxNQUFNLE9BQU8sQ0FBQztBQUMvQixPQUFPLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBMEMsTUFBTSxPQUFPLENBQUM7QUFFL0UsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUNwQyxPQUFPLEVBQWMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLE1BQU0sQ0FBQzs7QUFVdEQsTUFBTSxpQkFBaUIsR0FBNEI7SUFDakQsS0FBSyxFQUFFLElBQUk7SUFDWCxTQUFTLEVBQUUsSUFBSTtJQUNmLHFCQUFxQixFQUFFLElBQUk7Q0FDNUIsQ0FBQztBQUdGLE1BQU0sT0FBTyxlQUFlO0lBWTFCLElBQVcsTUFBTTtRQUNmLE9BQU8sSUFBSSxDQUFDLGtCQUFrQixFQUFFLFVBQVUsQ0FBQztJQUM3QyxDQUFDO0lBSUQsWUFBMkIsTUFBYztRQUFkLFdBQU0sR0FBTixNQUFNLENBQVE7UUFaakMsVUFBSyxHQUFHLElBQUksS0FBSyxFQUFFLENBQUM7UUFDcEIsZUFBVSxHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7UUFDeEIsa0JBQWEsR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBQ25DLHdCQUFtQixHQUFHLElBQUksWUFBWSxFQUFlLENBQUM7UUFDL0QsVUFBSyxHQUFhLEVBQUUsQ0FBQztRQVMzQixJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1FBQy9FLElBQUksQ0FB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O2dCQUNuRCxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQWMsQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO2FBQ3REO1lBRUQsSUFBSSxDQUFDLGNBQWMsRUFBRSxPQUFPLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1NBQzdDO0lBQ0gsQ0FBQzs7NEdBbE1VLGVBQWU7Z0hBQWYsZUFBZTsyRkFBZixlQUFlO2tCQUQzQixVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRXZlbnRFbWl0dGVyLCBmb3J3YXJkUmVmLCBJbmplY3QsIEluamVjdGFibGUsIE5nWm9uZSwgT25EZXN0cm95IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgKiBhcyBUSFJFRSBmcm9tICd0aHJlZSc7XG5pbXBvcnQgeyBDbG9jaywgVmVjdG9yNCwgV2ViR0xSZW5kZXJlciwgV2ViR0xSZW5kZXJlclBhcmFtZXRlcnMgfSBmcm9tICd0aHJlZSc7XG5pbXBvcnQgeyBUaFZpZXcgfSBmcm9tICcuL1RoVmlldyc7XG5pbXBvcnQgeyBpc09ic2VydmVkIH0gZnJvbSAnLi91dGlsJztcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QsIHRha2VVbnRpbCB9IGZyb20gJ3J4anMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIFJlbmRlclN0YXRlIHtcbiAgZW5naW5lOiBUaEVuZ2luZVNlcnZpY2U7XG4gIGRlbHRhOiBudW1iZXI7XG59XG5leHBvcnQgaW50ZXJmYWNlIFRoUmVuZGVyZXJQYXJhbWV0ZXJzIGV4dGVuZHMgUGFydGlhbDxXZWJHTFJlbmRlcmVyPiB7XG4gIGRvbUVsZW1lbnQ6IEhUTUxDYW52YXNFbGVtZW50O1xufVxuXG5jb25zdCBSRU5ERVJFUl9ERUZBVUxUUzogV2ViR0xSZW5kZXJlclBhcmFtZXRlcnMgPSB7XG4gIGFscGhhOiB0cnVlLCAvLyB0cmFuc3BhcmVudCBiYWNrZ3JvdW5kXG4gIGFudGlhbGlhczogdHJ1ZSwgLy8gc21vb3RoIGVkZ2VzXG4gIHByZXNlcnZlRHJhd2luZ0J1ZmZlcjogdHJ1ZVxufTtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFRoRW5naW5lU2VydmljZSBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG4gIHB1YmxpYyByZWFkb25seSBiZWZvcmVSZW5kZXIkOiBPYnNlcnZhYmxlPFJlbmRlclN0YXRlPjtcbiAgcHVibGljIHJlYWRvbmx5IHJlc2l6ZSQ6IE9ic2VydmFibGU8eyB3aWR0aDogbnVtYmVyOyBoZWlnaHQ6IG51bWJlciB9PjtcblxuICBwcml2YXRlIF9yZW5kZXJlcj86IFRIUkVFLldlYkdMUmVuZGVyZXI7XG4gIHByaXZhdGUgcmVuZGVyZXJQYXJhbWV0ZXJzPzogVGhSZW5kZXJlclBhcmFtZXRlcnM7XG4gIHByaXZhdGUgY2xvY2sgPSBuZXcgQ2xvY2soKTtcbiAgcHJpdmF0ZSBkZXN0cm95ZWQkID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcbiAgcHJpdmF0ZSByZWFkb25seSByZXNpemVFbWl0dGVyID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBwcml2YXRlIHJlYWRvbmx5IGJlZm9yZVJlbmRlckVtaXR0ZXIgPSBuZXcgRXZlbnRFbWl0dGVyPFJlbmRlclN0YXRlPigpO1xuICBwcml2YXRlIHZpZXdzOiBUaFZpZXdbXSA9IFtdO1xuXG4gIHB1YmxpYyBnZXQgY2FudmFzKCk6IEhUTUxDYW52YXNFbGVtZW50IHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5yZW5kZXJlclBhcmFtZXRlcnM/LmRvbUVsZW1lbnQ7XG4gIH1cblxuICBwcml2YXRlIHJlc2l6ZU9ic2VydmVyPzogUmVzaXplT2JzZXJ2ZXI7XG5cbiAgcHVibGljIGNvbnN0cnVjdG9yKHByaXZhdGUgbmdab25lOiBOZ1pvbmUpIHtcbiAgICB0aGlzLmJlZm9yZVJlbmRlciQgPSB0aGlzLmJlZm9yZVJlbmRlckVtaXR0ZXIucGlwZSh0YWtlVW50aWwodGhpcy5kZXN0cm95ZWQkKSk7XG4gICAgdGhpcy5yZXNpemUkID0gdGhpcy5yZXNpemVFbWl0dGVyLnBpcGUodGFrZVVudGlsKHRoaXMuZGVzdHJveWVkJCkpO1xuICB9XG5cbiAgcHVibGljIGdldCByZW5kZXJlcigpIHtcbiAgICByZXR1cm4gdGhpcy5fcmVuZGVyZXI7XG4gIH1cblxuICBwdWJsaWMgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgaWYgKHRoaXMucmVzaXplT2JzZXJ2ZXIgJiYgdGhpcy5jYW52YXMpIHtcbiAgICAgIHRoaXMucmVzaXplT2JzZXJ2ZXIudW5vYnNlcnZlKHRoaXMuY2FudmFzKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGluaXRSZXNpemVPYnNlcnZlcigpIHtcbiAgICAvLyBXZSBoYXZlIHRvIHJ1biB0aGlzIG91dHNpZGUgYW5ndWxhciB6b25lcyxcbiAgICAvLyBiZWNhdXNlIGl0IGNvdWxkIHRyaWdnZXIgaGVhdnkgY2hhbmdlRGV0ZWN0aW9uIGN5Y2xlcy5cbiAgICB0aGlzLm5nWm9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG4gICAgICBpZiAoIXRoaXMuY2FudmFzKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignbWlzc2luZyBjYW52YXMgZWxlbWVudCcpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLnJlc2l6ZSgpO1xuICAgICAgaWYgKCF0aGlzLnJlc2l6ZU9ic2VydmVyKSB7XG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgdGhpcy5yZXNpemVPYnNlcnZlciA9IG5ldyBSZXNpemVPYnNlcnZlcigoKSA9PiB7XG4gICAgICAgICAgdGhpcy5yZXNpemUoKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICB0aGlzLnJlc2l6ZU9ic2VydmVyLm9ic2VydmUodGhpcy5jYW52YXMpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0UmVuZGVyZXIoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuX3JlbmRlcmVyKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuX3JlbmRlcmVyID0gbmV3IFRIUkVFLldlYkdMUmVuZGVyZXIoe1xuICAgICAgY2FudmFzOiB0aGlzLnJlbmRlcmVyUGFyYW1ldGVycz8uZG9tRWxlbWVudCxcbiAgICAgIC4uLlJFTkRFUkVSX0RFRkFVTFRTXG4gICAgfSk7XG5cbiAgICBPYmplY3QuYXNzaWduKHRoaXMuX3JlbmRlcmVyLCB7IC4uLlJFTkRFUkVSX0RFRkFVTFRTLCAuLi50aGlzLnJlbmRlcmVyUGFyYW1ldGVycyB9KTtcbiAgICB0aGlzLnJlc2l6ZSgpO1xuICB9XG5cbiAgcHVibGljIHNldFJlbmRlcmVyKG9wdGlvbnM6IFRoUmVuZGVyZXJQYXJhbWV0ZXJzKSB7XG4gICAgdGhpcy5yZW5kZXJlclBhcmFtZXRlcnMgPSBvcHRpb25zO1xuICAgIHRoaXMuaW5pdFJlbmRlcmVyKCk7XG4gICAgdGhpcy5pbml0UmVzaXplT2JzZXJ2ZXIoKTtcbiAgfVxuXG4gIHB1YmxpYyBhZGRWaWV3KHZpZXc6IFRoVmlldykge1xuICAgIHRoaXMudmlld3MucHVzaCh2aWV3KTtcbiAgICBjb25zdCBjYW52YXNEaW1lbnNpb25zID0gdGhpcy5jYWxjUmVuZGVyZXJTaXplKCk7XG4gICAgaWYgKGNhbnZhc0RpbWVuc2lvbnMpIHtcbiAgICAgIHRoaXMuYWRqdXN0Vmlld0RpbWVuc2lvbnModmlldywgY2FudmFzRGltZW5zaW9ucy53aWR0aCwgY2FudmFzRGltZW5zaW9ucy5oZWlnaHQpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyByZW5kZXIoKTogdm9pZCB7XG4gICAgdGhpcy5iZWZvcmVSZW5kZXJFbWl0dGVyLmVtaXQoeyBlbmdpbmU6IHRoaXMsIGRlbHRhOiB0aGlzLmNsb2NrLmdldERlbHRhKCkgfSk7XG4gICAgZm9yIChjb25zdCB2aWV3IG9mIHRoaXMudmlld3MpIHtcbiAgICAgIHRoaXMucmVuZGVyVmlldyh2aWV3KTtcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgcmVuZGVyVmlldyh2aWV3OiBUaFZpZXcpIHtcbiAgICBpZiAoIXRoaXMuX3JlbmRlcmVyKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgY2FtZXJhID0gdmlldy5jYW1lcmE7XG4gICAgY29uc3Qgc2NlbmUgPSB2aWV3LnNjZW5lO1xuXG4gICAgaWYgKCFjYW1lcmEgfHwgIXNjZW5lIHx8ICFjYW1lcmEub2JqUmVmIHx8ICFzY2VuZS5vYmpSZWYpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCByZW5kZXJlciA9IHRoaXMuX3JlbmRlcmVyO1xuXG4gICAgaWYgKGlzT2JzZXJ2ZWQodmlldy5vblJlbmRlcikpIHtcbiAgICAgIHRoaXMubmdab25lLnJ1bigoKSA9PlxuICAgICAgICB2aWV3Lm9uUmVuZGVyLmVtaXQoe1xuICAgICAgICAgIHJlbmRlcmVyLFxuICAgICAgICAgIHNjZW5lLFxuICAgICAgICAgIGNhbWVyYVxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9XG5cbiAgICB0aGlzLmFwcGx5UmVuZGVyZXJQYXJhbWV0ZXJzRnJvbVZpZXcodmlldyk7XG4gICAgaWYgKHZpZXcuZWZmZWN0Q29tcG9zZXIpIHtcbiAgICAgIHZpZXcuZWZmZWN0Q29tcG9zZXIucmVuZGVyKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX3JlbmRlcmVyLnJlbmRlcihzY2VuZS5vYmpSZWYsIGNhbWVyYS5vYmpSZWYpO1xuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBhcHBseVJlbmRlcmVyUGFyYW1ldGVyc0Zyb21WaWV3KHZpZXc6IFRoVmlldykge1xuICAgIGlmICghdGhpcy5fcmVuZGVyZXIpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHZpZXcudmlld1BvcnQpIHtcbiAgICAgIGlmICh2aWV3LnZpZXdQb3J0IGluc3RhbmNlb2YgVmVjdG9yNCkge1xuICAgICAgICB0aGlzLl9yZW5kZXJlci5zZXRWaWV3cG9ydCh2aWV3LnZpZXdQb3J0KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuX3JlbmRlcmVyLnNldFZpZXdwb3J0KHZpZXcudmlld1BvcnQueCwgdmlldy52aWV3UG9ydC55LCB2aWV3LnZpZXdQb3J0LndpZHRoLCB2aWV3LnZpZXdQb3J0LmhlaWdodCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHZpZXcuc2Npc3Nvcikge1xuICAgICAgaWYgKHZpZXcuc2Npc3NvciBpbnN0YW5jZW9mIFZlY3RvcjQpIHtcbiAgICAgICAgdGhpcy5fcmVuZGVyZXIuc2V0U2Npc3Nvcih2aWV3LnNjaXNzb3IpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5fcmVuZGVyZXIuc2V0U2Npc3Nvcih2aWV3LnNjaXNzb3IueCwgdmlldy5zY2lzc29yLnksIHZpZXcuc2Npc3Nvci53aWR0aCwgdmlldy5zY2lzc29yLmhlaWdodCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHZpZXcuc2Npc3NvclRlc3QgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy5fcmVuZGVyZXIuc2V0U2Npc3NvclRlc3Qodmlldy5zY2lzc29yVGVzdCk7XG4gICAgfVxuXG4gICAgaWYgKHZpZXcuY2xlYXJDb2xvcikge1xuICAgICAgdGhpcy5fcmVuZGVyZXIuc2V0Q2xlYXJDb2xvcih2aWV3LmNsZWFyQ29sb3IpO1xuICAgIH1cblxuICAgIGlmICh2aWV3LmNsZWFyQWxwaGEgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy5fcmVuZGVyZXIuc2V0Q2xlYXJBbHBoYSh2aWV3LmNsZWFyQWxwaGEpO1xuICAgIH1cblxuICAgIGlmICh2aWV3LnNoYWRvdyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aGlzLl9yZW5kZXJlci5zaGFkb3dNYXAuZW5hYmxlZCA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHJlc2l6ZSgpIHtcbiAgICBpZiAoIXRoaXMuX3JlbmRlcmVyIHx8ICF0aGlzLmNhbnZhcykge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLW5vbi1udWxsLWFzc2VydGlvblxuICAgIGNvbnN0IHsgd2lkdGgsIGhlaWdodCB9ID0gdGhpcy5jYWxjUmVuZGVyZXJTaXplKCkhO1xuXG4gICAgdGhpcy5fcmVuZGVyZXIuc2V0U2l6ZSh3aWR0aCwgaGVpZ2h0LCBmYWxzZSk7XG5cbiAgICBmb3IgKGNvbnN0IHZpZXcgb2YgdGhpcy52aWV3cykge1xuICAgICAgdGhpcy5hZGp1c3RWaWV3RGltZW5zaW9ucyh2aWV3LCB3aWR0aCwgaGVpZ2h0KTtcbiAgICB9XG5cbiAgICB0aGlzLnJlc2l6ZUVtaXR0ZXIuZW1pdCh7IHdpZHRoLCBoZWlnaHQgfSk7XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHByb3RlY3RlZCBjYWxjUmVuZGVyZXJTaXplKCkge1xuICAgIGlmICghdGhpcy5fcmVuZGVyZXIgfHwgIXRoaXMuY2FudmFzKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgcGl4ZWxSYXRpbyA9IHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvO1xuICAgIHJldHVybiB7XG4gICAgICB3aWR0aDogKHRoaXMuY2FudmFzLmNsaWVudFdpZHRoID8/IDApICogcGl4ZWxSYXRpbyxcbiAgICAgIGhlaWdodDogKHRoaXMuY2FudmFzLmNsaWVudEhlaWdodCA/PyAwKSAqIHBpeGVsUmF0aW9cbiAgICB9O1xuICB9XG5cbiAgcHJvdGVjdGVkIGFkanVzdFZpZXdEaW1lbnNpb25zKHZpZXc6IFRoVmlldywgd2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIpIHtcbiAgICBpZiAoIXZpZXcudmlld1BvcnQpIHtcbiAgICAgIGlmICh2aWV3LmNhbWVyYSAmJiAodmlldy5jYW1lcmEub2JqUmVmIGFzIGFueSkuYXNwZWN0KSB7XG4gICAgICAgICh2aWV3LmNhbWVyYS5vYmpSZWYgYXMgYW55KS5hc3BlY3QgPSB3aWR0aCAvIGhlaWdodDtcbiAgICAgICAgKHZpZXcuY2FtZXJhLm9ialJlZiBhcyBhbnkpLnVwZGF0ZVByb2plY3Rpb25NYXRyaXgoKTtcbiAgICAgIH1cblxuICAgICAgdmlldy5lZmZlY3RDb21wb3Nlcj8uc2V0U2l6ZSh3aWR0aCwgaGVpZ2h0KTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==