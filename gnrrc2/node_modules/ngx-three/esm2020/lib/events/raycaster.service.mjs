import { inject, Injectable, InjectionToken } from '@angular/core';
import * as THREE from 'three';
import { Raycaster } from 'three';
import * as i0 from "@angular/core";
// eslint-disable-next-line no-shadow
export var RaycasterEvent;
(function (RaycasterEvent) {
    RaycasterEvent["mouseEnter"] = "mouseEnter";
    RaycasterEvent["mouseExit"] = "mouseExit";
    RaycasterEvent["click"] = "click";
    RaycasterEvent["pointerDown"] = "pointerDown";
    RaycasterEvent["pointerUp"] = "pointerUp";
})(RaycasterEvent || (RaycasterEvent = {}));
export const RAYCASTER = new InjectionToken('A reference to the raycaster object', {
    factory: () => new Raycaster()
});
export class RaycasterService {
    constructor() {
        this.raycaster = inject(RAYCASTER);
        this.selected = null;
        this.enabled = true;
        this.groups = [];
        this.paused = false;
        this.maxClickDistance = 23;
        this.nid = RaycasterService.instanceCnt++;
        this.onPointerMove = this.onPointerMove.bind(this);
        this.onPointerDown = this.onPointerDown.bind(this);
        this.onPointerUp = this.onPointerUp.bind(this);
    }
    ngOnDestroy() {
        this.disable();
        this.unsubscribe();
    }
    subscribe() {
        if (!this.canvas) {
            throw new Error('missing canvas');
        }
        this.canvas.addEventListener('pointermove', this.onPointerMove);
        this.canvas.addEventListener('pointerdown', this.onPointerDown);
        this.canvas.addEventListener('pointerup', this.onPointerUp);
    }
    unsubscribe() {
        if (!this.canvas) {
            throw new Error('missing canvas');
        }
        this.canvas.removeEventListener('pointermove', this.onPointerMove);
        this.canvas.removeEventListener('pointerdown', this.onPointerDown);
        this.canvas.removeEventListener('pointerup', this.onPointerUp);
    }
    enable() {
        this.enabled = true;
    }
    disable() {
        this.enabled = false;
    }
    pause() {
        this.paused = true;
    }
    resume() {
        this.paused = false;
    }
    get isEnabled() {
        return this.enabled;
    }
    init(camera, canvas) {
        // console.log('Add camera to raycaster', camera);
        this.camera = camera;
        this.canvas = canvas;
        this.subscribe();
    }
    addEventTarget(target) {
        // console.log('RaycasterService.addGroup', group.name, group);
        this.groups.push(target);
    }
    removeEventTarget(target) {
        const index = this.groups.indexOf(target);
        if (index >= 0) {
            this.groups.splice(index, 1);
        }
    }
    onPointerMove(event /*MouseEvent  & { layerX: number, layerY: number}*/) {
        if (!this.isReady()) {
            return;
        }
        const i = this.getFirstIntersectedGroup(event.layerX, event.layerY, RaycasterEvent.mouseEnter);
        if (!this.selected || this.selected !== i?.target) {
            if (this.selected) {
                this.selected.host.objRef?.dispatchEvent({
                    type: RaycasterEvent.mouseExit,
                    component: this.selected.host
                });
                this.selected.emitOnMouseExit();
                this.selected = null;
            }
            if (i && i.target) {
                this.selected = i.target;
                const evt = {
                    type: RaycasterEvent.mouseEnter,
                    component: i.target.host,
                    ...i
                };
                this.selected.host.objRef?.dispatchEvent(evt);
                this.selected.emitOnMouseEnter(evt);
            }
        }
    }
    onPointerDown(event) {
        this.maxClickDistance = event.width;
        this.pointerDownEvent = event;
        if (!this.isReady()) {
            return;
        }
        const i = this.getFirstIntersectedGroup(event.layerX, event.layerY, RaycasterEvent.pointerDown);
        if (i && i.target && i.target.host.objRef) {
            const evt = { type: RaycasterEvent.pointerDown, component: i.target.host, ...i };
            i.target.host.objRef.dispatchEvent(evt);
            i.target.emitOnPointerDown(evt);
        }
    }
    onPointerUp(event) {
        const downEvent = this.pointerDownEvent;
        this.pointerDownEvent = undefined;
        if (!this.isReady()) {
            return;
        }
        // pointer up
        let i = this.getFirstIntersectedGroup(event.layerX, event.layerY, RaycasterEvent.pointerUp);
        if (i && i.target && i.target.host.objRef) {
            const evt = { type: RaycasterEvent.pointerUp, component: i.target.host, ...i };
            i.target.host.objRef.dispatchEvent(evt);
            i.target.emitOnPointerUp(evt);
        }
        // click
        if (this.calcPointerDownUpDinstance(event, downEvent) > this.maxClickDistance) {
            return;
        }
        i = this.getFirstIntersectedGroup(event.layerX, event.layerY, RaycasterEvent.click);
        if (i && i.target && i.target.host.objRef) {
            const evt = { type: RaycasterEvent.click, component: i.target.host, ...i };
            i.target.host.objRef.dispatchEvent(evt);
            i.target.emitOnClick(evt);
        }
    }
    isReady(ignorePaused) {
        return !!(this.enabled &&
            (ignorePaused || !this.paused) &&
            this.camera &&
            this.camera.objRef &&
            this.groups &&
            this.groups.length > 0);
    }
    calcPointerDownUpDinstance(upEvent, downEvent) {
        if (!downEvent) {
            return Number.MAX_VALUE;
        }
        const xDist = upEvent.layerX - downEvent.layerX;
        const yDist = upEvent.layerY - downEvent.layerY;
        return Math.sqrt(xDist * xDist + yDist * yDist);
    }
    getFirstIntersectedGroup(x, y, event) {
        if (!this.camera || !this.canvas || !this.camera.objRef) {
            return;
        }
        x = (x / this.canvas.clientWidth) * 2 - 1;
        y = -(y / this.canvas.clientHeight) * 2 + 1;
        const mouseVector = new THREE.Vector2(x, y);
        this.raycaster.setFromCamera(mouseVector, this.camera.objRef);
        // loop across all groups. Try to find the group with nearest distance.
        let nearestIntersection;
        let nearestGroup;
        for (const group of this.groups) {
            const i = group.host.objRef;
            if (!group[event] || !i) {
                continue;
            }
            const intersection = this.raycaster.intersectObject(i, true);
            if (intersection.length > 0 &&
                (!nearestIntersection || nearestIntersection.distance > intersection[0].distance)) {
                nearestIntersection = intersection[0];
                nearestGroup = group;
            }
        }
        // return the group with nearest distance
        if (nearestGroup && nearestIntersection) {
            return {
                target: nearestGroup,
                ...nearestIntersection
            };
        }
        else {
            return undefined;
        }
    }
}
RaycasterService.instanceCnt = 0;
RaycasterService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.1.1", ngImport: i0, type: RaycasterService, deps: [], target: i0.ɵɵFactoryTarget.Injectable });
RaycasterService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.1.1", ngImport: i0, type: RaycasterService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.1.1", ngImport: i0, type: RaycasterService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return []; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmF5Y2FzdGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtdGhyZWUvc3JjL2xpYi9ldmVudHMvcmF5Y2FzdGVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsY0FBYyxFQUFhLE1BQU0sZUFBZSxDQUFDO0FBQzlFLE9BQU8sS0FBSyxLQUFLLE1BQU0sT0FBTyxDQUFDO0FBQy9CLE9BQU8sRUFBZ0IsU0FBUyxFQUFFLE1BQU0sT0FBTyxDQUFDOztBQUloRCxxQ0FBcUM7QUFDckMsTUFBTSxDQUFOLElBQVksY0FNWDtBQU5ELFdBQVksY0FBYztJQUN4QiwyQ0FBeUIsQ0FBQTtJQUN6Qix5Q0FBdUIsQ0FBQTtJQUN2QixpQ0FBZSxDQUFBO0lBQ2YsNkNBQTJCLENBQUE7SUFDM0IseUNBQXVCLENBQUE7QUFDekIsQ0FBQyxFQU5XLGNBQWMsS0FBZCxjQUFjLFFBTXpCO0FBRUQsTUFBTSxDQUFDLE1BQU0sU0FBUyxHQUFHLElBQUksY0FBYyxDQUFZLHFDQUFxQyxFQUFFO0lBQzVGLE9BQU8sRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLFNBQVMsRUFBRTtDQUMvQixDQUFDLENBQUM7QUFPSCxNQUFNLE9BQU8sZ0JBQWdCO0lBb0IzQjtRQWxCUSxjQUFTLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQzlCLGFBQVEsR0FBbUMsSUFBSSxDQUFDO1FBQ2hELFlBQU8sR0FBRyxJQUFJLENBQUM7UUFFZixXQUFNLEdBQW1DLEVBQUUsQ0FBQztRQUM1QyxXQUFNLEdBQUcsS0FBSyxDQUFDO1FBRWYscUJBQWdCLEdBQUcsRUFBRSxDQUFDO1FBU2QsUUFBRyxHQUFHLGdCQUFnQixDQUFDLFdBQVcsRUFBRSxDQUFDO1FBR25ELElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENB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LEVBQUU7WUFDL0IsTUFBTSxDQUFDLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7WUFDNUIsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRTtnQkFDdkIsU0FBUzthQUNWO1lBQ0QsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxlQUFlLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQzdELElBQ0UsWUFBWSxDQUFDLE1BQU0sR0FBRyxDQUFDO2dCQUN2QixDQUFDLENBQUMsbUJBQW1CLElBQUksbUJBQW1CLENBQUMsUUFBUSxHQUFHLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsRUFDakY7Z0JBQ0EsbUJBQW1CLEdBQUcsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN0QyxZQUFZLEdBQUcsS0FBSyxDQUFDO2FBQ3RCO1NBQ0Y7UUFFRCx5Q0FBeUM7UUFDekMsSUFBSSxZQUFZLElBQUksbUJBQW1CLEVBQUU7WUFDdkMsT0FBTztnQkFDTCxNQUFNLEVBQUUsWUFBWTtnQkFDcEIsR0FBRyxtQkFBbUI7YUFDdkIsQ0FBQztTQUNIO2FBQU07WUFDTCxPQUFPLFNBQVMsQ0FBQztTQUNsQjtJQUNILENBQUM7O0FBNU1jLDRCQUFXLEdBQUcsQ0FBQyxDQUFDOzZHQVhwQixnQkFBZ0I7aUhBQWhCLGdCQUFnQjsyRkFBaEIsZ0JBQWdCO2tCQUQ1QixVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaW5qZWN0LCBJbmplY3RhYmxlLCBJbmplY3Rpb25Ub2tlbiwgT25EZXN0cm95IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgKiBhcyBUSFJFRSBmcm9tICd0aHJlZSc7XG5pbXBvcnQgeyBJbnRlcnNlY3Rpb24sIFJheWNhc3RlciB9IGZyb20gJ3RocmVlJztcbmltcG9ydCB7IFRoQ2FtZXJhIH0gZnJvbSAnLi4vZ2VuZXJhdGVkL1RoQ2FtZXJhJztcbmltcG9ydCB7IFJheWNhc3RlckV2ZW50RGlyZWN0aXZlIH0gZnJvbSAnLi9yYXljYXN0ZXIuZXZlbnRzLmRpcmVjdGl2ZSc7XG5cbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1zaGFkb3dcbmV4cG9ydCBlbnVtIFJheWNhc3RlckV2ZW50IHtcbiAgbW91c2VFbnRlciA9ICdtb3VzZUVudGVyJyxcbiAgbW91c2VFeGl0ID0gJ21vdXNlRXhpdCcsXG4gIGNsaWNrID0gJ2NsaWNrJyxcbiAgcG9pbnRlckRvd24gPSAncG9pbnRlckRvd24nLFxuICBwb2ludGVyVXAgPSAncG9pbnRlclVwJ1xufVxuXG5leHBvcnQgY29uc3QgUkFZQ0FTVEVSID0gbmV3IEluamVjdGlvblRva2VuPFJheWNhc3Rlcj4oJ0EgcmVmZXJlbmNlIHRvIHRoZSByYXljYXN0ZXIgb2JqZWN0Jywge1xuICBmYWN0b3J5OiAoKSA9PiBuZXcgUmF5Y2FzdGVyKClcbn0pO1xuXG5pbnRlcmZhY2UgTmVhcmVzdEludGVyc2VjdGlvbiBleHRlbmRzIEludGVyc2VjdGlvbiB7XG4gIHRhcmdldD86IFJheWNhc3RlckV2ZW50RGlyZWN0aXZlIHwgbnVsbDtcbn1cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFJheWNhc3RlclNlcnZpY2UgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xuICBwcml2YXRlIGNhbnZhcz86IEhUTUxDYW52YXNFbGVtZW50O1xuICBwcml2YXRlIHJheWNhc3RlciA9IGluamVjdChSQVlDQVNURVIpO1xuICBwcml2YXRlIHNlbGVjdGVkOiBSYXljYXN0ZXJFdmVudERpcmVjdGl2ZSB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIGVuYWJsZWQgPSB0cnVlO1xuICBwcml2YXRlIGNhbWVyYT86IFRoQ2FtZXJhO1xuICBwcml2YXRlIGdyb3VwczogQXJyYXk8UmF5Y2FzdGVyRXZlbnREaXJlY3RpdmU+ID0gW107XG4gIHByaXZhdGUgcGF1c2VkID0gZmFsc2U7XG5cbiAgcHJpdmF0ZSBtYXhDbGlja0Rpc3RhbmNlID0gMjM7XG5cbiAgcHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2VDbnQgPSAwO1xuXG4gIC8qKlxuICAgKiB0YXJnZXRzIG9mIHRoZSBwb2ludGVyIGRvd24gZXZlbnRcbiAgICovXG4gIHByaXZhdGUgcG9pbnRlckRvd25FdmVudD86IFBvaW50ZXJFdmVudDtcblxuICBwdWJsaWMgcmVhZG9ubHkgbmlkID0gUmF5Y2FzdGVyU2VydmljZS5pbnN0YW5jZUNudCsrO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMub25Qb2ludGVyTW92ZSA9IHRoaXMub25Qb2ludGVyTW92ZS5iaW5kKHRoaXMpO1xuICAgIHRoaXMub25Qb2ludGVyRG93biA9IHRoaXMub25Qb2ludGVyRG93bi5iaW5kKHRoaXMpO1xuICAgIHRoaXMub25Qb2ludGVyVXAgPSB0aGlzLm9uUG9pbnRlclVwLmJpbmQodGhpcyk7XG4gIH1cblxuICBwdWJsaWMgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5kaXNhYmxlKCk7XG4gICAgdGhpcy51bnN1YnNjcmliZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBzdWJzY3JpYmUoKSB7XG4gICAgaWYgKCF0aGlzLmNhbnZhcykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdtaXNzaW5nIGNhbnZhcycpO1xuICAgIH1cbiAgICB0aGlzLmNhbnZhcy5hZGRFdmVudExpc3RlbmVyKCdwb2ludGVybW92ZScsIHRoaXMub25Qb2ludGVyTW92ZSk7XG4gICAgdGhpcy5jYW52YXMuYWRkRXZlbnRMaXN0ZW5lcigncG9pbnRlcmRvd24nLCB0aGlzLm9uUG9pbnRlckRvd24pO1xuICAgIHRoaXMuY2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoJ3BvaW50ZXJ1cCcsIHRoaXMub25Qb2ludGVyVXApO1xuICB9XG5cbiAgcHJpdmF0ZSB1bnN1YnNjcmliZSgpIHtcbiAgICBpZiAoIXRoaXMuY2FudmFzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ21pc3NpbmcgY2FudmFzJyk7XG4gICAgfVxuICAgIHRoaXMuY2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3BvaW50ZXJtb3ZlJywgdGhpcy5vblBvaW50ZXJNb3ZlKTtcbiAgICB0aGlzLmNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCdwb2ludGVyZG93bicsIHRoaXMub25Qb2ludGVyRG93bik7XG4gICAgdGhpcy5jYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcigncG9pbnRlcnVwJywgdGhpcy5vblBvaW50ZXJVcCk7XG4gIH1cblxuICBwdWJsaWMgZW5hYmxlKCkge1xuICAgIHRoaXMuZW5hYmxlZCA9IHRydWU7XG4gIH1cblxuICBwdWJsaWMgZGlzYWJsZSgpIHtcbiAgICB0aGlzLmVuYWJsZWQgPSBmYWxzZTtcbiAgfVxuXG4gIHB1YmxpYyBwYXVzZSgpIHtcbiAgICB0aGlzLnBhdXNlZCA9IHRydWU7XG4gIH1cblxuICBwdWJsaWMgcmVzdW1lKCkge1xuICAgIHRoaXMucGF1c2VkID0gZmFsc2U7XG4gIH1cblxuICBnZXQgaXNFbmFibGVkKCkge1xuICAgIHJldHVybiB0aGlzLmVuYWJsZWQ7XG4gIH1cblxuICBwdWJsaWMgaW5pdChjYW1lcmE6IFRoQ2FtZXJhLCBjYW52YXM6IEhUTUxDYW52YXNFbGVtZW50KSB7XG4gICAgLy8gY29uc29sZS5sb2coJ0FkZCBjYW1lcmEgdG8gcmF5Y2FzdGVyJywgY2FtZXJhKTtcbiAgICB0aGlzLmNhbWVyYSA9IGNhbWVyYTtcbiAgICB0aGlzLmNhbnZhcyA9IGNhbnZhcztcbiAgICB0aGlzLnN1YnNjcmliZSgpO1xuICB9XG5cbiAgcHVibGljIGFkZEV2ZW50VGFyZ2V0KHRhcmdldDogUmF5Y2FzdGVyRXZlbnREaXJlY3RpdmUpIHtcbiAgICAvLyBjb25zb2xlLmxvZygnUmF5Y2FzdGVyU2VydmljZS5hZGRHcm91cCcsIGdyb3VwLm5hbWUsIGdyb3VwKTtcbiAgICB0aGlzLmdyb3Vwcy5wdXNoKHRhcmdldCk7XG4gIH1cblxuICBwdWJsaWMgcmVtb3ZlRXZlbnRUYXJnZXQodGFyZ2V0OiBSYXljYXN0ZXJFdmVudERpcmVjdGl2ZSkge1xuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5ncm91cHMuaW5kZXhPZih0YXJnZXQpO1xuICAgIGlmIChpbmRleCA+PSAwKSB7XG4gICAgICB0aGlzLmdyb3Vwcy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgb25Qb2ludGVyTW92ZShldmVudDogYW55IC8qTW91c2VFdmVudCAgJiB7IGxheWVyWDogbnVtYmVyLCBsYXllclk6IG51bWJlcn0qLykge1xuICAgIGlmICghdGhpcy5pc1JlYWR5KCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgaSA9IHRoaXMuZ2V0Rmlyc3RJbnRlcnNlY3RlZEdyb3VwKGV2ZW50LmxheWVyWCwgZXZlbnQubGF5ZXJZLCBSYXljYXN0ZXJFdmVudC5tb3VzZUVudGVyKTtcbiAgICBpZiAoIXRoaXMuc2VsZWN0ZWQgfHwgdGhpcy5zZWxlY3RlZCAhPT0gaT8udGFyZ2V0KSB7XG4gICAgICBpZiAodGhpcy5zZWxlY3RlZCkge1xuICAgICAgICB0aGlzLnNlbGVjdGVkLmhvc3Qub2JqUmVmPy5kaXNwYXRjaEV2ZW50KHtcbiAgICAgICAgICB0eXBlOiBSYXljYXN0ZXJFdmVudC5tb3VzZUV4aXQsXG4gICAgICAgICAgY29tcG9uZW50OiB0aGlzLnNlbGVjdGVkLmhvc3RcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuc2VsZWN0ZWQuZW1pdE9uTW91c2VFeGl0KCk7XG4gICAgICAgIHRoaXMuc2VsZWN0ZWQgPSBudWxsO1xuICAgICAgfVxuICAgICAgaWYgKGkgJiYgaS50YXJnZXQpIHtcbiAgICAgICAgdGhpcy5zZWxlY3RlZCA9IGkudGFyZ2V0O1xuICAgICAgICBjb25zdCBldnQgPSB7XG4gICAgICAgICAgdHlwZTogUmF5Y2FzdGVyRXZlbnQubW91c2VFbnRlcixcbiAgICAgICAgICBjb21wb25lbnQ6IGkudGFyZ2V0Lmhvc3QsXG4gICAgICAgICAgLi4uaVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLnNlbGVjdGVkLmhvc3Qub2JqUmVmPy5kaXNwYXRjaEV2ZW50KGV2dCk7XG4gICAgICAgIHRoaXMuc2VsZWN0ZWQuZW1pdE9uTW91c2VFbnRlcihldnQpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgb25Qb2ludGVyRG93bihldmVudDogUG9pbnRlckV2ZW50KSB7XG4gICAgdGhpcy5tYXhDbGlja0Rpc3RhbmNlID0gZXZlbnQud2lkdGg7XG4gICAgdGhpcy5wb2ludGVyRG93bkV2ZW50ID0gZXZlbnQ7XG5cbiAgICBpZiAoIXRoaXMuaXNSZWFkeSgpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgaSA9IHRoaXMuZ2V0Rmlyc3RJbnRlcnNlY3RlZEdyb3VwKChldmVudCBhcyBhbnkpLmxheWVyWCwgKGV2ZW50IGFzIGFueSkubGF5ZXJZLCBSYXljYXN0ZXJFdmVudC5wb2ludGVyRG93bik7XG4gICAgaWYgKGkgJiYgaS50YXJnZXQgJiYgaS50YXJnZXQuaG9zdC5vYmpSZWYpIHtcbiAgICAgIGNvbnN0IGV2dCA9IHsgdHlwZTogUmF5Y2FzdGVyRXZlbnQucG9pbnRlckRvd24sIGNvbXBvbmVudDogaS50YXJnZXQuaG9zdCwgLi4uaSB9O1xuICAgICAgaS50YXJnZXQuaG9zdC5vYmpSZWYuZGlzcGF0Y2hFdmVudChldnQpO1xuICAgICAgaS50YXJnZXQuZW1pdE9uUG9pbnRlckRvd24oZXZ0KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG9uUG9pbnRlclVwKGV2ZW50OiBQb2ludGVyRXZlbnQpIHtcbiAgICBjb25zdCBkb3duRXZlbnQgPSB0aGlzLnBvaW50ZXJEb3duRXZlbnQ7XG4gICAgdGhpcy5wb2ludGVyRG93bkV2ZW50ID0gdW5kZWZpbmVkO1xuXG4gICAgaWYgKCF0aGlzLmlzUmVhZHkoKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIHBvaW50ZXIgdXBcbiAgICBsZXQgaSA9IHRoaXMuZ2V0Rmlyc3RJbnRlcnNlY3RlZEdyb3VwKChldmVudCBhcyBhbnkpLmxheWVyWCwgKGV2ZW50IGFzIGFueSkubGF5ZXJZLCBSYXljYXN0ZXJFdmVudC5wb2ludGVyVXApO1xuICAgIGlmIChpICYmIGkudGFyZ2V0ICYmIGkudGFyZ2V0Lmhvc3Qub2JqUmVmKSB7XG4gICAgICBjb25zdCBldnQgPSB7IHR5cGU6IFJheWNhc3RlckV2ZW50LnBvaW50ZXJVcCwgY29tcG9uZW50OiBpLnRhcmdldC5ob3N0LCAuLi5pIH07XG4gICAgICBpLnRhcmdldC5ob3N0Lm9ialJlZi5kaXNwYXRjaEV2ZW50KGV2dCk7XG4gICAgICBpLnRhcmdldC5lbWl0T25Qb2ludGVyVXAoZXZ0KTtcbiAgICB9XG5cbiAgICAvLyBjbGlja1xuICAgIGlmICh0aGlzLmNhbGNQb2ludGVyRG93blVwRGluc3RhbmNlKGV2ZW50LCBkb3duRXZlbnQpID4gdGhpcy5tYXhDbGlja0Rpc3RhbmNlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGkgPSB0aGlzLmdldEZpcnN0SW50ZXJzZWN0ZWRHcm91cCgoZXZlbnQgYXMgYW55KS5sYXllclgsIChldmVudCBhcyBhbnkpLmxheWVyWSwgUmF5Y2FzdGVyRXZlbnQuY2xpY2spO1xuICAgIGlmIChpICYmIGkudGFyZ2V0ICYmIGkudGFyZ2V0Lmhvc3Qub2JqUmVmKSB7XG4gICAgICBjb25zdCBldnQgPSB7IHR5cGU6IFJheWNhc3RlckV2ZW50LmNsaWNrLCBjb21wb25lbnQ6IGkudGFyZ2V0Lmhvc3QsIC4uLmkgfTtcbiAgICAgIGkudGFyZ2V0Lmhvc3Qub2JqUmVmLmRpc3BhdGNoRXZlbnQoZXZ0KTtcbiAgICAgIGkudGFyZ2V0LmVtaXRPbkNsaWNrKGV2dCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBpc1JlYWR5KGlnbm9yZVBhdXNlZD86IGJvb2xlYW4pOiBib29sZWFuIHtcbiAgICByZXR1cm4gISEoXG4gICAgICB0aGlzLmVuYWJsZWQgJiZcbiAgICAgIChpZ25vcmVQYXVzZWQgfHwgIXRoaXMucGF1c2VkKSAmJlxuICAgICAgdGhpcy5jYW1lcmEgJiZcbiAgICAgIHRoaXMuY2FtZXJhLm9ialJlZiAmJlxuICAgICAgdGhpcy5ncm91cHMgJiZcbiAgICAgIHRoaXMuZ3JvdXBzLmxlbmd0aCA+IDBcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBjYWxjUG9pbnRlckRvd25VcERpbnN0YW5jZSh1cEV2ZW50OiBQb2ludGVyRXZlbnQsIGRvd25FdmVudD86IFBvaW50ZXJFdmVudCkge1xuICAgIGlmICghZG93bkV2ZW50KSB7XG4gICAgICByZXR1cm4gTnVtYmVyLk1BWF9WQUxVRTtcbiAgICB9XG4gICAgY29uc3QgeERpc3QgPSAodXBFdmVudCBhcyBhbnkpLmxheWVyWCAtIChkb3duRXZlbnQgYXMgYW55KS5sYXllclg7XG4gICAgY29uc3QgeURpc3QgPSAodXBFdmVudCBhcyBhbnkpLmxheWVyWSAtIChkb3duRXZlbnQgYXMgYW55KS5sYXllclk7XG4gICAgcmV0dXJuIE1hdGguc3FydCh4RGlzdCAqIHhEaXN0ICsgeURpc3QgKiB5RGlzdCk7XG4gIH1cblxuICBwcml2YXRlIGdldEZpcnN0SW50ZXJzZWN0ZWRHcm91cCh4OiBudW1iZXIsIHk6IG51bWJlciwgZXZlbnQ6IFJheWNhc3RlckV2ZW50KTogTmVhcmVzdEludGVyc2VjdGlvbiB8IHVuZGVmaW5lZCB7XG4gICAgaWYgKCF0aGlzLmNhbWVyYSB8fCAhdGhpcy5jYW52YXMgfHwgIXRoaXMuY2FtZXJhLm9ialJlZikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB4ID0gKHggLyB0aGlzLmNhbnZhcy5jbGllbnRXaWR0aCkgKiAyIC0gMTtcbiAgICB5ID0gLSh5IC8gdGhpcy5jYW52YXMuY2xpZW50SGVpZ2h0KSAqIDIgKyAxO1xuICAgIGNvbnN0IG1vdXNlVmVjdG9yID0gbmV3IFRIUkVFLlZlY3RvcjIoeCwgeSk7XG4gICAgdGhpcy5yYXljYXN0ZXIuc2V0RnJvbUNhbWVyYShtb3VzZVZlY3RvciwgdGhpcy5jYW1lcmEub2JqUmVmKTtcblxuICAgIC8vIGxvb3AgYWNyb3NzIGFsbCBncm91cHMuIFRyeSB0byBmaW5kIHRoZSBncm91cCB3aXRoIG5lYXJlc3QgZGlzdGFuY2UuXG4gICAgbGV0IG5lYXJlc3RJbnRlcnNlY3Rpb246IFRIUkVFLkludGVyc2VjdGlvbiB8IHVuZGVmaW5lZDtcbiAgICBsZXQgbmVhcmVzdEdyb3VwOiBSYXljYXN0ZXJFdmVudERpcmVjdGl2ZSB8IHVuZGVmaW5lZDtcbiAgICBmb3IgKGNvbnN0IGdyb3VwIG9mIHRoaXMuZ3JvdXBzKSB7XG4gICAgICBjb25zdCBpID0gZ3JvdXAuaG9zdC5vYmpSZWY7XG4gICAgICBpZiAoIWdyb3VwW2V2ZW50XSB8fCAhaSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGludGVyc2VjdGlvbiA9IHRoaXMucmF5Y2FzdGVyLmludGVyc2VjdE9iamVjdChpLCB0cnVlKTtcbiAgICAgIGlmIChcbiAgICAgICAgaW50ZXJzZWN0aW9uLmxlbmd0aCA+IDAgJiZcbiAgICAgICAgKCFuZWFyZXN0SW50ZXJzZWN0aW9uIHx8IG5lYXJlc3RJbnRlcnNlY3Rpb24uZGlzdGFuY2UgPiBpbnRlcnNlY3Rpb25bMF0uZGlzdGFuY2UpXG4gICAgICApIHtcbiAgICAgICAgbmVhcmVzdEludGVyc2VjdGlvbiA9IGludGVyc2VjdGlvblswXTtcbiAgICAgICAgbmVhcmVzdEdyb3VwID0gZ3JvdXA7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gcmV0dXJuIHRoZSBncm91cCB3aXRoIG5lYXJlc3QgZGlzdGFuY2VcbiAgICBpZiAobmVhcmVzdEdyb3VwICYmIG5lYXJlc3RJbnRlcnNlY3Rpb24pIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHRhcmdldDogbmVhcmVzdEdyb3VwLFxuICAgICAgICAuLi5uZWFyZXN0SW50ZXJzZWN0aW9uXG4gICAgICB9O1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgfVxufVxuIl19